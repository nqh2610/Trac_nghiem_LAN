<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√†m b√†i tr·∫Øc nghi·ªám</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        
        .login-box h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .login-box .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .login-box .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .login-box label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .login-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .login-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-box select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: white;
            cursor: pointer;
        }
        
        .login-box select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-box select option:disabled {
            color: #999;
            background: #f5f5f5;
        }
        
        .login-box select option.completed {
            color: #28a745;
        }
        
        .login-box select option.selected-by-other {
            color: #dc3545;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-group.half {
            flex: 1;
        }
        
        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-sm {
            padding: 10px 20px;
            font-size: 0.95em;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .info-message {
            background: #e7f3ff;
            color: #0056b3;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .selected-student-info {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .selected-student-info .name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2e7d32;
        }
        
        .report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .report-modal.show {
            display: flex;
        }
        
        .report-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 450px;
            width: 90%;
        }
        
        .report-box h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        .status-badge.completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.selected {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Exam Screen */
        .exam-screen {
            display: none;
        }
        
        .exam-header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            position: sticky;
            top: 20px;
            z-index: 100;
        }
        
        .exam-title {
            font-size: 1.3em;
            color: #333;
            font-weight: bold;
        }
        
        .exam-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .timer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .timer.warning {
            background: #ffc107;
            color: #333;
            animation: pulse 1s infinite;
        }
        
        .timer.danger {
            background: #dc3545;
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .student-name {
            color: #666;
        }
        
        .wrong-name-link {
            color: #dc3545;
            font-size: 0.8em;
            margin-left: 8px;
            text-decoration: underline;
            cursor: pointer;
        }
        
        .wrong-name-link:hover {
            color: #a71d2a;
        }
        
        /* Questions */
        .question-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .question-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
        }
        
        .question-status {
            font-size: 0.9em;
            color: #666;
        }
        
        .question-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .question-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .option {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }
        
        .option input {
            display: none;
        }
        
        .option-label {
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .option.selected .option-label {
            background: #28a745;
        }
        
        .option-text {
            font-size: 1.05em;
            color: #333;
        }
        
        /* Navigation */
        .question-nav {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .nav-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .nav-btn {
            width: 45px;
            height: 45px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            border-color: #667eea;
        }
        
        .nav-btn.answered {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .nav-btn.current {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }
        
        /* Submit */
        .submit-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .submit-info {
            margin-bottom: 20px;
            color: #666;
        }
        
        .submit-info strong {
            color: #333;
        }
        
        /* Result Screen */
        .result-screen {
            display: none;
        }
        
        .result-box {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .result-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .result-score {
            font-size: 4em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .result-label {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }
        
        .result-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .result-row:last-child {
            border-bottom: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .exam-header {
                flex-direction: column;
                text-align: center;
            }
            
            .exam-info {
                justify-content: center;
            }
            
            .question-card {
                padding: 20px;
            }
            
            .login-box {
                padding: 30px 20px;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üéì B√†i Ki·ªÉm Tra</h1>
            <p class="subtitle" id="examTitleDisplay">Tr·∫Øc nghi·ªám tr·ª±c tuy·∫øn</p>
            
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div class="selected-student-info" id="selectedStudentInfo" style="display: none;">
                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">‚ö†Ô∏è H√£y ki·ªÉm tra k·ªπ tr∆∞·ªõc khi x√°c nh·∫≠n:</div>
                <div class="name" id="selectedStudentName"></div>
                <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 0.9em;">
                    ‚ö†Ô∏è <strong>L∆∞u √Ω:</strong> N·∫øu b·∫°n l√†m b√†i v·ªõi t√™n ng∆∞·ªùi kh√°c, ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c t√≠nh cho ng∆∞·ªùi ƒë√≥!
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-success btn-sm" onclick="confirmSelection()" id="confirmBtn">‚úÖ ƒê√∫ng t√™n t√¥i, ti·∫øp t·ª•c</button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="cancelSelection()">‚ùå Kh√¥ng ph·∫£i, ch·ªçn l·∫°i</button>
                </div>
            </div>
            
            <div id="selectStudentSection">
                <div class="form-group">
                    <label>Ch·ªçn t√™n c·ªßa b·∫°n:</label>
                    <select id="studentSelect" required>
                        <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
                    </select>
                </div>
            </div>
            
            <form id="loginForm" style="display: none;">
                <div class="form-group">
                    <label>L·ªõp:</label>
                    <input type="text" id="studentClass" placeholder="VD: 10A1" required>
                </div>
                
                <button type="submit" class="btn btn-primary" id="startBtn">üöÄ B·∫Øt ƒë·∫ßu l√†m b√†i</button>
            </form>
        </div>
    </div>
    
    <!-- Report Modal -->
    <div class="report-modal" id="reportModal">
        <div class="report-box">
            <h3>‚ö†Ô∏è B√°o c√°o ch·ªçn nh·∫ßm</h3>
            <p>B·∫°n ƒë√£ ch·ªçn: <strong id="wrongStudentName"></strong></p>
            
            <div class="form-group">
                <label>Ch·ªçn t√™n ƒë√∫ng c·ªßa b·∫°n:</label>
                <select id="correctStudentSelect" required>
                    <option value="">-- Ch·ªçn t√™n ƒë√∫ng --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>L√Ω do (t√πy ch·ªçn):</label>
                <input type="text" id="reportReason" placeholder="VD: B·∫•m nh·∫ßm">
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="submitReport()">G·ª≠i b√°o c√°o</button>
                <button class="btn btn-danger" onclick="closeReportModal()">H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Exam Screen -->
    <div class="exam-screen" id="examScreen">
        <div class="container">
            <div class="exam-header">
                <div class="exam-title" id="examTitle">B√†i ki·ªÉm tra tr·∫Øc nghi·ªám</div>
                <div class="exam-info">
                    <span class="student-name">üë§ <span id="displayName"></span> - <span id="displayClass"></span>
                        <a href="javascript:void(0)" onclick="reportWrongSelectionDuringExam()" class="wrong-name-link">Sai t√™n?</a>
                    </span>
                    <div class="timer" id="timer">00:00</div>
                </div>
            </div>

            <div class="question-nav">
                <div class="nav-title">üìã C√¢u h·ªèi (<span id="answeredCount">0</span>/<span id="totalCount">0</span> ƒë√£ tr·∫£ l·ªùi)</div>
                <div class="nav-buttons" id="navButtons"></div>
            </div>

            <div id="questionsContainer"></div>

            <div class="submit-section">
                <div class="submit-info">
                    B·∫°n ƒë√£ tr·∫£ l·ªùi <strong><span id="answeredCount2">0</span>/<span id="totalCount2">0</span></strong> c√¢u h·ªèi
                </div>
                <button class="btn btn-success" onclick="submitExam()">üì§ N·ªôp b√†i</button>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div class="result-screen" id="resultScreen">
        <div class="container">
            <div class="result-box">
                <div class="result-icon" id="resultIcon">üéâ</div>
                <div class="result-score" id="resultScore">0</div>
                <div class="result-label">ƒëi·ªÉm</div>
                
                <div class="result-details">
                    <div class="result-row">
                        <span>S·ªë c√¢u ƒë√∫ng:</span>
                        <strong id="correctCount">0/0</strong>
                    </div>
                    <div class="result-row">
                        <span>Th·ªùi gian l√†m b√†i:</span>
                        <strong id="timeSpent">00:00</strong>
                    </div>
                </div>
                
                <p style="color: #666;">K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c g·ª≠i v·ªÅ gi√°o vi√™n!</p>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        let mySocketId = null;
        let studentInfo = { name: '', class: '', stt: '' };
        let selectedStudent = null;
        let students = [];
        let questions = [];
        let answers = {};
        let timeLimit = 30;
        let timeRemaining = 0;
        let timerInterval = null;
        let startTime = null;

        // Nh·∫≠n socket ID
        socket.on('connected', (data) => {
            mySocketId = data.socketId;
            console.log('Connected with socket ID:', mySocketId);
            loadStudents();
        });

        // Load danh s√°ch h·ªçc sinh
        async function loadStudents() {
            try {
                const res = await fetch('/api/students');
                students = await res.json();
                renderStudentSelect();
            } catch (err) {
                showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch h·ªçc sinh');
            }
        }

        // Render dropdown h·ªçc sinh
        function renderStudentSelect() {
            const select = document.getElementById('studentSelect');
            
            if (students.length === 0) {
                select.innerHTML = '<option value="">-- Ch∆∞a c√≥ danh s√°ch h·ªçc sinh --</option>';
                return;
            }
            
            select.innerHTML = '<option value="">-- Ch·ªçn t√™n c·ªßa b·∫°n --</option>' + 
                students.map(s => {
                    let statusText = '';
                    let disabled = false;
                    let className = '';
                    
                    if (s.status.completed && !s.status.canRetry) {
                        statusText = ' ‚úÖ (ƒê√£ ho√†n th√†nh)';
                        disabled = true;
                        className = 'completed';
                    } else if (s.status.selected && s.status.selectedBy !== mySocketId) {
                        statusText = ' üîí (ƒê√£ c√≥ ng∆∞·ªùi ch·ªçn)';
                        disabled = true;
                        className = 'selected-by-other';
                    } else if (s.status.canRetry) {
                        statusText = ' üîÑ (ƒê∆∞·ª£c l√†m l·∫°i)';
                    }
                    
                    return `<option value="${s.stt}" ${disabled ? 'disabled' : ''} class="${className}">
                        ${s.stt}. ${s.fullName}${statusText}
                    </option>`;
                }).join('');
            
            // N·∫øu ƒë√£ ch·ªçn tr∆∞·ªõc ƒë√≥
            if (selectedStudent) {
                select.value = selectedStudent.stt;
            }
        }

        // Render dropdown cho b√°o c√°o
        function renderCorrectStudentSelect() {
            const select = document.getElementById('correctStudentSelect');
            
            select.innerHTML = '<option value="">-- Ch·ªçn t√™n ƒë√∫ng --</option>' + 
                students.filter(s => !s.status.completed && !s.status.selected)
                    .map(s => `<option value="${s.stt}">${s.stt}. ${s.fullName}</option>`)
                    .join('');
        }

        // Check exam status on load
        async function checkExam() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                
                document.getElementById('examTitleDisplay').textContent = data.title;
                
                if (!data.isOpen) {
                    showError('B√†i thi ch∆∞a ƒë∆∞·ª£c m·ªü. Vui l√≤ng ch·ªù gi√°o vi√™n!');
                    document.getElementById('startBtn').disabled = true;
                }
                return data.isOpen;
            } catch (err) {
                showError('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server');
                return false;
            }
        }

        // Show error
        function showError(msg) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        // Show success
        function showSuccess(msg) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = msg;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }

        let nameConfirmed = false;

        // Khi ch·ªçn h·ªçc sinh t·ª´ dropdown
        document.getElementById('studentSelect').addEventListener('change', async (e) => {
            const stt = e.target.value;
            nameConfirmed = false;
            document.getElementById('loginForm').style.display = 'none';
            
            if (!stt) {
                document.getElementById('selectedStudentInfo').style.display = 'none';
                selectedStudent = null;
                return;
            }
            
            try {
                const res = await fetch('/api/select-student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stt, socketId: mySocketId })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    selectedStudent = data.student;
                    document.getElementById('selectedStudentInfo').style.display = 'block';
                    document.getElementById('selectedStudentName').textContent = 
                        `${selectedStudent.stt}. ${selectedStudent.ho} ${selectedStudent.ten}`;
                    showSuccess('H√£y x√°c nh·∫≠n ƒë√¢y c√≥ ph·∫£i t√™n c·ªßa b·∫°n!');
                } else {
                    showError(data.error);
                    e.target.value = '';
                    selectedStudent = null;
                }
            } catch (err) {
                showError('Kh√¥ng th·ªÉ ch·ªçn h·ªçc sinh');
            }
        });

        // X√°c nh·∫≠n ƒë√∫ng t√™n
        function confirmSelection() {
            if (!selectedStudent) return;
            nameConfirmed = true;
            document.getElementById('selectStudentSection').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('selectedStudentInfo').innerHTML = `
                <div style="color: #28a745;">‚úÖ ƒê√£ x√°c nh·∫≠n:</div>
                <div class="name">${selectedStudent.stt}. ${selectedStudent.ho} ${selectedStudent.ten}</div>
                <button type="button" class="btn btn-warning btn-sm" onclick="reportWrongSelection()" style="margin-top: 10px;">‚ö†Ô∏è Ch·ªçn nh·∫ßm? B√°o gi√°o vi√™n</button>
            `;
            showSuccess('ƒê√£ x√°c nh·∫≠n! Nh·∫≠p l·ªõp v√† b·∫Øt ƒë·∫ßu l√†m b√†i.');
        }

        // H·ªßy ch·ªçn
        async function cancelSelection() {
            if (!selectedStudent) return;
            
            try {
                await fetch('/api/deselect-student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stt: selectedStudent.stt, socketId: mySocketId })
                });
                
                selectedStudent = null;
                nameConfirmed = false;
                document.getElementById('studentSelect').value = '';
                document.getElementById('selectedStudentInfo').style.display = 'none';
                document.getElementById('selectStudentSection').style.display = 'block';
                document.getElementById('loginForm').style.display = 'none';
                // Kh√¥i ph·ª•c l·∫°i n·ªôi dung selectedStudentInfo
                document.getElementById('selectedStudentInfo').innerHTML = `
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">‚ö†Ô∏è H√£y ki·ªÉm tra k·ªπ tr∆∞·ªõc khi x√°c nh·∫≠n:</div>
                    <div class="name" id="selectedStudentName"></div>
                    <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 0.9em;">
                        ‚ö†Ô∏è <strong>L∆∞u √Ω:</strong> N·∫øu b·∫°n l√†m b√†i v·ªõi t√™n ng∆∞·ªùi kh√°c, ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c t√≠nh cho ng∆∞·ªùi ƒë√≥!
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-success btn-sm" onclick="confirmSelection()" id="confirmBtn">‚úÖ ƒê√∫ng t√™n t√¥i, ti·∫øp t·ª•c</button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="cancelSelection()">‚ùå Kh√¥ng ph·∫£i, ch·ªçn l·∫°i</button>
                    </div>
                `;
                loadStudents();
            } catch (err) {
                showError('Kh√¥ng th·ªÉ h·ªßy ch·ªçn');
            }
        }

        // B√°o sai t√™n khi ƒëang l√†m b√†i
        function reportWrongSelectionDuringExam() {
            if (!confirm('B·∫°n ƒëang l√†m b√†i v·ªõi t√™n sai?\n\nN·∫øu ti·∫øp t·ª•c b√°o c√°o:\n- B√†i l√†m c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c gi·ªØ nguy√™n\n- Gi√°o vi√™n s·∫Ω x·ª≠ l√Ω chuy·ªÉn ƒëi·ªÉm cho b·∫°n\n\nB·∫•m OK ƒë·ªÉ b√°o gi√°o vi√™n')) return;
            
            const correctName = prompt('Nh·∫≠p STT ƒë√∫ng c·ªßa b·∫°n trong danh s√°ch (VD: 15):');
            if (!correctName) return;
            
            const correctSTT = parseInt(correctName);
            if (isNaN(correctSTT)) {
                alert('Vui l√≤ng nh·∫≠p s·ªë STT!');
                return;
            }
            
            // G·ª≠i b√°o c√°o
            fetch('/api/report-wrong-selection', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    wrongSTT: studentInfo.stt,
                    correctSTT: correctSTT,
                    reason: 'B√°o c√°o khi ƒëang l√†m b√†i',
                    socketId: mySocketId
                })
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    alert('ƒê√£ g·ª≠i b√°o c√°o cho gi√°o vi√™n!\n\nB·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c l√†m b√†i. Gi√°o vi√™n s·∫Ω x·ª≠ l√Ω sau.');
                } else {
                    alert('L·ªói: ' + data.error);
                }
            });
        }

        // M·ªü modal b√°o c√°o
        function reportWrongSelection() {
            if (!selectedStudent) return;
            
            document.getElementById('wrongStudentName').textContent = 
                `${selectedStudent.ho} ${selectedStudent.ten}`;
            renderCorrectStudentSelect();
            document.getElementById('reportModal').classList.add('show');
        }

        // ƒê√≥ng modal
        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('show');
        }

        // G·ª≠i b√°o c√°o
        async function submitReport() {
            const correctSTT = document.getElementById('correctStudentSelect').value;
            const reason = document.getElementById('reportReason').value;
            
            if (!correctSTT) {
                alert('Vui l√≤ng ch·ªçn t√™n ƒë√∫ng c·ªßa b·∫°n!');
                return;
            }
            
            try {
                const res = await fetch('/api/report-wrong-selection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wrongSTT: selectedStudent.stt,
                        correctSTT,
                        reason,
                        socketId: mySocketId
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showSuccess('ƒê√£ g·ª≠i b√°o c√°o cho gi√°o vi√™n. Vui l√≤ng ch·ªù x·ª≠ l√Ω!');
                    closeReportModal();
                } else {
                    showError(data.error);
                }
            } catch (err) {
                showError('Kh√¥ng th·ªÉ g·ª≠i b√°o c√°o');
            }
        }

        // Login form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedStudent || !nameConfirmed) {
                showError('Vui l√≤ng ch·ªçn v√† x√°c nh·∫≠n t√™n c·ªßa b·∫°n');
                return;
            }
            
            const studentClass = document.getElementById('studentClass').value.trim();
            
            if (!studentClass) {
                showError('Vui l√≤ng nh·∫≠p l·ªõp');
                return;
            }
            
            // Check if exam is open
            const res = await fetch('/api/exam');
            const data = await res.json();
            
            if (data.error) {
                showError(data.error);
                return;
            }
            
            studentInfo = { 
                name: `${selectedStudent.ho} ${selectedStudent.ten}`, 
                class: studentClass, 
                stt: selectedStudent.stt 
            };
            questions = data.questions;
            timeLimit = data.timeLimit;
            
            document.getElementById('examTitle').textContent = data.title;
            
            startExam();
        });

        // Start exam
        function startExam() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('examScreen').style.display = 'block';
            
            document.getElementById('displayName').textContent = studentInfo.name;
            document.getElementById('displayClass').textContent = `L·ªõp ${studentInfo.class} - STT ${studentInfo.stt}`;
            
            renderQuestions();
            renderNavigation();
            startTimer();
            
            startTime = new Date();
        }

        // Render questions
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            
            container.innerHTML = questions.map((q, i) => `
                <div class="question-card" id="question${i}">
                    <div class="question-header">
                        <span class="question-number">C√¢u ${i + 1}</span>
                    </div>
                    <div class="question-text">${q.question}</div>
                    ${q.image ? `<img src="${q.image}" class="question-image" alt="H√¨nh minh h·ªça">` : ''}
                    <div class="options">
                        ${q.options.map((opt, j) => `
                            <label class="option" onclick="selectOption(${i}, ${j})">
                                <input type="radio" name="q${i}" value="${j}">
                                <span class="option-label">${String.fromCharCode(65 + j)}</span>
                                <span class="option-text">${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('totalCount').textContent = questions.length;
            document.getElementById('totalCount2').textContent = questions.length;
        }

        // Select option
        function selectOption(questionIndex, optionIndex) {
            answers[questionIndex] = optionIndex;
            
            // Update UI
            const options = document.querySelectorAll(`#question${questionIndex} .option`);
            options.forEach((opt, i) => {
                opt.classList.toggle('selected', i === optionIndex);
            });
            
            updateProgress();
        }

        // Render navigation
        function renderNavigation() {
            const container = document.getElementById('navButtons');
            
            container.innerHTML = questions.map((_, i) => `
                <button class="nav-btn" id="nav${i}" onclick="scrollToQuestion(${i})">${i + 1}</button>
            `).join('');
        }

        // Update progress
        function updateProgress() {
            const answered = Object.keys(answers).length;
            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('answeredCount2').textContent = answered;
            
            // Update nav buttons
            questions.forEach((_, i) => {
                const btn = document.getElementById(`nav${i}`);
                btn.classList.toggle('answered', answers[i] !== undefined);
            });
        }

        // Scroll to question
        function scrollToQuestion(index) {
            document.getElementById(`question${index}`).scrollIntoView({ behavior: 'smooth' });
        }

        // Timer
        function startTimer() {
            timeRemaining = timeLimit * 60;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert('‚è∞ H·∫øt gi·ªù! B√†i c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c n·ªôp t·ª± ƒë·ªông.');
                    submitExam(true);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timer = document.getElementById('timer');
            timer.textContent = display;
            
            // Warning colors
            timer.classList.remove('warning', 'danger');
            if (timeRemaining <= 60) {
                timer.classList.add('danger');
            } else if (timeRemaining <= 300) {
                timer.classList.add('warning');
            }
        }

        // Submit exam
        async function submitExam(autoSubmit = false) {
            if (!autoSubmit && !confirm('B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i?')) return;
            
            clearInterval(timerInterval);
            
            const endTime = new Date();
            const timeSpentMs = endTime - startTime;
            const timeSpentMinutes = Math.floor(timeSpentMs / 60000);
            const timeSpentSeconds = Math.floor((timeSpentMs % 60000) / 1000);
            const timeSpent = `${timeSpentMinutes} ph√∫t ${timeSpentSeconds} gi√¢y`;
            
            // Prepare answers array
            const answersArray = [];
            for (let i = 0; i < questions.length; i++) {
                answersArray.push(answers[i] !== undefined ? answers[i] : -1);
            }
            
            try {
                const res = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentSTT: studentInfo.stt,
                        studentName: studentInfo.name,
                        studentClass: studentInfo.class,
                        answers: answersArray,
                        timeSpent
                    })
                });
                
                const result = await res.json();
                
                if (result.success) {
                    showResult(result, timeSpent);
                } else {
                    alert('C√≥ l·ªói khi n·ªôp b√†i. Vui l√≤ng th·ª≠ l·∫°i!');
                }
            } catch (err) {
                alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!');
            }
        }

        // Show result
        function showResult(result, timeSpent) {
            document.getElementById('examScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';
            
            document.getElementById('resultScore').textContent = result.score;
            document.getElementById('correctCount').textContent = `${result.correctCount}/${result.totalQuestions}`;
            document.getElementById('timeSpent').textContent = timeSpent;
            
            // Icon based on score
            const icon = document.getElementById('resultIcon');
            if (result.score >= 8) {
                icon.textContent = 'üéâ';
            } else if (result.score >= 5) {
                icon.textContent = 'üëç';
            } else {
                icon.textContent = 'üí™';
            }
        }

        // Listen for exam status changes
        socket.on('examStatusChanged', (isOpen) => {
            if (isOpen) {
                document.getElementById('startBtn').disabled = !selectedStudent;
                showSuccess('Gi√°o vi√™n ƒë√£ m·ªü b√†i thi!');
            } else {
                showError('Gi√°o vi√™n ƒë√£ ƒë√≥ng b√†i thi!');
                document.getElementById('startBtn').disabled = true;
            }
        });

        // Listen for student status updates
        socket.on('studentStatusUpdated', (data) => {
            loadStudents();
        });

        // Listen for report processed
        socket.on('reportProcessed', (data) => {
            if (data.status === 'approved') {
                showSuccess('B√°o c√°o ƒë√£ ƒë∆∞·ª£c duy·ªát! Vui l√≤ng ch·ªçn l·∫°i t√™n.');
                selectedStudent = null;
                document.getElementById('selectedStudentInfo').style.display = 'none';
                document.getElementById('startBtn').disabled = true;
            } else if (data.status === 'rejected') {
                showError('B√°o c√°o b·ªã t·ª´ ch·ªëi.');
            }
            loadStudents();
        });

        // Listen for all students reset
        socket.on('allStudentsReset', () => {
            showSuccess('Danh s√°ch ƒë√£ ƒë∆∞·ª£c reset!');
            selectedStudent = null;
            document.getElementById('selectedStudentInfo').style.display = 'none';
            document.getElementById('startBtn').disabled = true;
            loadStudents();
        });

        // Listen for retry allowed
        socket.on('retryAllowed', (data) => {
            if (selectedStudent && selectedStudent.stt == data.stt) {
                showSuccess('Gi√°o vi√™n cho ph√©p b·∫°n l√†m l·∫°i b√†i!');
            }
            loadStudents();
        });

        // Initialize
        checkExam();
    </script>
</body>
</html>
