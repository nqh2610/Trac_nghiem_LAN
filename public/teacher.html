<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trắc Nghiệm LAN - Giáo viên</title>
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        header h1 {
            color: #333;
            font-size: 1.8em;
            margin: 0;
        }
        
        .logo-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .brand-logo {
            width: 50px;
            height: 50px;
        }
        
        .brand-text {
            display: flex;
            flex-direction: column;
        }
        
        .brand-tagline {
            font-size: 0.8em;
            color: #888;
            margin-top: 2px;
        }
        
        .header-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .status-open {
            background: #d4edda;
            color: #155724;
        }
        
        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 0;
        }
        
        .tab {
            padding: 12px 25px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: white;
            color: #667eea;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        
        .panel {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 0 15px 15px 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .panel.active {
            display: block;
        }
        
        /* Form thêm câu hỏi */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .option-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option-input input[type="radio"] {
            width: auto;
        }
        
        .option-input input[type="text"] {
            flex: 1;
        }
        
        .option-label {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        /* Danh sách câu hỏi */
        .question-list {
            margin-top: 30px;
        }
        
        .question-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .question-number {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .question-actions {
            display: flex;
            gap: 10px;
        }
        
        .question-actions button {
            padding: 5px 15px;
            font-size: 0.85em;
        }
        
        .question-text {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #333;
        }
        
        .question-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .question-option {
            padding: 10px 15px;
            background: white;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .question-option.correct {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        
        /* Bảng kết quả */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th, .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .results-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .score-high {
            color: #28a745;
            font-weight: bold;
        }
        
        .score-medium {
            color: #ffc107;
            font-weight: bold;
        }
        
        .score-low {
            color: #dc3545;
            font-weight: bold;
        }
        
        /* Cài đặt */
        .settings-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .settings-card h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .setting-row:last-child {
            border-bottom: none;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 30px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: #28a745;
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            opacity: 0.9;
        }
        
        /* Thông báo real-time */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .options-grid, .question-options {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                text-align: center;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .import-section {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px dashed #667eea;
        }

        .import-section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .import-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .file-label {
            cursor: pointer;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .detail-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .detail-correct {
            background: #d4edda;
        }

        .detail-wrong {
            background: #f8d7da;
        }

        /* Student status badges */
        .student-status {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .student-status.available {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .student-status.selected {
            background: #fff3e0;
            color: #e65100;
        }

        .student-status.completed {
            background: #e3f2fd;
            color: #1565c0;
        }

        .student-status.can-retry {
            background: #fce4ec;
            color: #c2185b;
        }

        /* Report item */
        .report-item {
            background: #fff8e1;
            border: 1px solid #ffca28;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .report-item .report-info {
            margin-bottom: 10px;
        }

        .report-item .report-actions {
            display: flex;
            gap: 10px;
        }

        .report-item .report-actions button {
            padding: 5px 15px;
            font-size: 0.85em;
        }

        /* ========== HỆ THỐNG THÔNG BÁO ĐẸP ========== */
        /* Alert Modal */
        .alert-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .alert-modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert-modal-header {
            padding: 20px 24px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .alert-modal-icon.success { background: #d4edda; }
        .alert-modal-icon.error { background: #f8d7da; }
        .alert-modal-icon.warning { background: #fff3cd; }
        .alert-modal-icon.info { background: #cce5ff; }

        .alert-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .alert-modal-body {
            padding: 16px 24px;
            color: #555;
            font-size: 15px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .alert-modal-footer {
            padding: 16px 24px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .alert-modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .alert-modal-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .alert-modal-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .alert-modal-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .alert-modal-btn.secondary:hover {
            background: #e0e0e0;
        }

        /* Toast notification đẹp hơn */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 450px;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }

        .toast-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .toast.success .toast-icon { background: #d4edda; }
        .toast.error .toast-icon { background: #f8d7da; }
        .toast.warning .toast-icon { background: #fff3cd; }
        .toast.info .toast-icon { background: #cce5ff; }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .toast-message {
            color: #666;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 4px;
            font-size: 18px;
            line-height: 1;
        }

        .toast-close:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-brand">
                <img src="/logo.svg" alt="Logo" class="brand-logo">
                <div class="brand-text">
                    <h1>Trắc Nghiệm LAN</h1>
                    <span class="brand-tagline">Hệ thống thi trắc nghiệm mạng LAN</span>
                </div>
            </div>
            <div class="header-info">
                <span>Tổng câu hỏi: <strong id="totalQuestions">0</strong></span>
                <span>Học sinh đã nộp: <strong id="totalSubmitted">0</strong></span>
                <span id="examStatus" class="status-badge status-closed">Chưa mở thi</span>
            </div>
        </header>

        <!-- Toast Container -->
        <div id="toastContainer" class="toast-container"></div>

        <!-- ========== SESSION HIỆN TẠI: LỚP + BÀI KIỂM TRA ========== -->
        <div class="settings-card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                
                <!-- Lớp hiện tại -->
                <div style="background: rgba(255,255,255,0.15); padding: 15px 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                            </div>
                        <div>
                            <p style="margin: 0; opacity: 0.85; font-size: 0.8em; text-transform: uppercase;">Lớp đang dạy</p>
                            <h3 id="currentClassName" style="margin: 3px 0 0 0; font-size: 1.2em;">Chưa chọn lớp</h3>
                            <p id="currentClassInfo" style="margin: 2px 0 0 0; opacity: 0.75; font-size: 0.8em;">0 học sinh</p>
                        </div>
                    </div>
                    <button class="btn" onclick="showClassManager()" style="background: white; color: #667eea; font-weight: bold; padding: 10px 15px; font-size: 0.9em; white-space: nowrap;">
                        Quản lý Lớp
                    </button>
                </div>
                
                <!-- Bài kiểm tra hiện tại -->
                <div style="background: rgba(255,255,255,0.15); padding: 15px 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                            </div>
                        <div>
                            <p style="margin: 0; opacity: 0.85; font-size: 0.8em; text-transform: uppercase;">Bài kiểm tra</p>
                            <h3 id="currentExamName" style="margin: 3px 0 0 0; font-size: 1.2em;">Chưa chọn bài</h3>
                            <p id="currentExamInfo" style="margin: 2px 0 0 0; opacity: 0.75; font-size: 0.8em;">0 câu hỏi</p>
                        </div>
                    </div>
                    <button class="btn" onclick="showExamManager()" style="background: white; color: #667eea; font-weight: bold; padding: 10px 15px; font-size: 0.9em; white-space: nowrap;">
                        Quản lý Đề
                    </button>
                </div>
            </div>
            
            <!-- Thông tin kết quả session hiện tại -->
            <div id="sessionResultInfo" style="margin-top: 15px; background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 25px;">
                <span>Kết quả: <strong id="sessionResultCount">0</strong> bài đã nộp</span>
                <span>Đang làm: <strong id="sessionInProgressCount">0</strong></span>
                <span>Hoàn thành: <strong id="sessionCompletedCount">0</strong></span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('questions')">Câu hỏi</button>
            <button class="tab" onclick="showTab('students')">Học sinh</button>
            <button class="tab" onclick="showTab('results')">Kết quả</button>
            <button class="tab" onclick="showTab('settings')">Cài đặt</button>
        </div>

        <!-- ========== MODAL QUẢN LÝ LỚP ========== -->
        <div id="classManagerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 20px; padding: 0; max-width: 700px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                
                <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 1.3em;">Quản lý Lớp học</h2>
                    <button onclick="hideClassManager()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.2em; cursor: pointer; padding: 8px 12px; border-radius: 8px;">X</button>
                </div>
                
                <div style="padding: 25px; max-height: calc(90vh - 80px); overflow-y: auto;">
                    
                    <!-- Hướng dẫn -->
                    <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #1565c0; font-size: 0.95em;">
                            <strong>Cách dùng:</strong> Tạo lớp → Upload danh sách học sinh (DS) → Chọn lớp để dạy
                        </p>
                    </div>
                    
                    <!-- Tạo lớp mới -->
                    <div style="background: #f5f5f5; border-radius: 12px; padding: 20px; border: 2px solid #e0e0e0; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            
                            <h4 style="margin: 0; color: #333;">Tạo lớp mới</h4>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newClassName" placeholder="VD: 10A1, Lớp Tin học K11..." style="flex: 1; padding: 12px; border: 1px solid #bdbdbd; border-radius: 8px;">
                            <button class="btn" onclick="createNewClass()" style="background: #1976D2; color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; white-space: nowrap;">
                                Tạo lớp
                            </button>
                        </div>
                    </div>
                    
                    <!-- Danh sách lớp -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                 Danh sách lớp đã tạo
                            </h4>
                            <span id="classCount" style="background: #1976D2; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">0 lớp</span>
                        </div>
                        <div id="classesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 10px;">
                            <p style="color: #666; text-align: center; padding: 30px;">Đang tải...</p>
                        </div>
                    </div>
                    
                    <!-- Tải mẫu Excel -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed #e0e0e0;">
                        <p style="margin: 0 0 10px 0; color: #666; font-size: 0.9em;"><strong>Tải mẫu Excel danh sách học sinh:</strong></p>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="downloadSampleExcel(1)" style="background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                Mẫu đầy đủ (STT, HO, TEN, NU)
                            </button>
                            <button onclick="downloadSampleExcel(2)" style="background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                Mẫu phổ biến (STT, TEN, NU)
                            </button>
                            <button onclick="downloadSampleExcel(3)" style="background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                Mẫu đơn giản (STT, TEN)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== MODAL QUẢN LÝ BÀI KIỂM TRA ========== -->
        <div id="examManagerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 20px; padding: 0; max-width: 700px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 1.3em;">Quản lý Bài kiểm tra</h2>
                    <button onclick="hideExamManager()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.2em; cursor: pointer; padding: 8px 12px; border-radius: 8px;">X</button>
                </div>
                
                <div style="padding: 25px; max-height: calc(90vh - 80px); overflow-y: auto;">
                    
                    <!-- Hướng dẫn -->
                    <div style="background: #f0f7ff; border: 1px solid #b3d4ff; border-radius: 10px; padding: 15px; margin-bottom: 25px;">
                        <p style="margin: 0; color: #0066cc; font-size: 0.95em;">
                            <strong>Mẹo:</strong> Cùng một bài kiểm tra có thể dùng cho nhiều lớp. Mỗi lớp có kết quả riêng!
                        </p>
                    </div>
                    
                    <!-- Tạo bài mới từ file -->
                    <div style="background: #e8f5e9; border-radius: 12px; padding: 20px; border: 2px solid #81c784; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            
                            <h4 style="margin: 0; color: #2e7d32;">Tạo bài mới từ file</h4>
                        </div>
                        <input type="text" id="newExamName" maxlength="40" placeholder="Tên bài kiểm tra (tối đa 40 ký tự)" style="width: 100%; padding: 12px; border: 1px solid #a5d6a7; border-radius: 8px; margin-bottom: 12px; box-sizing: border-box;">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <button class="btn" onclick="createNewExam()" style="background: #4caf50; color: white; padding: 12px; border-radius: 8px; font-weight: bold;">
                                Tạo bài trống
                            </button>
                            <label class="btn" style="background: #2196F3; color: white; padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; cursor: pointer;">
                                Upload Word
                                <input type="file" accept=".docx" style="display: none;" onchange="createExamFromFile(this, 'word')">
                            </label>
                            <label class="btn" style="background: #ff9800; color: white; padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; cursor: pointer;">
                                Upload JSON
                                <input type="file" accept=".json" style="display: none;" onchange="createExamFromFile(this, 'json')">
                            </label>
                        </div>
                        
                        <div style="margin-top: 12px; display: flex; gap: 10px; justify-content: center;">
                            <a href="/data/mau-cau-hoi.docx" download style="color: #666; font-size: 0.85em; text-decoration: underline;">Tải mẫu Word</a>
                            <a href="/data/mau-cau-hoi.json" download style="color: #666; font-size: 0.85em; text-decoration: underline;">Tải mẫu JSON</a>
                        </div>
                    </div>
                    
                    <!-- Lưu bài hiện tại -->
                    <div style="background: #fff8e1; border-radius: 12px; padding: 20px; border: 2px solid #ffcc02; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            
                            <h4 style="margin: 0; color: #f57f17;">Lưu bài đang làm</h4>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="saveExamName" maxlength="40" placeholder="Nhập tên để lưu (tối đa 40 ký tự)" style="flex: 1; padding: 12px; border: 1px solid #ffe082; border-radius: 8px; box-sizing: border-box;">
                            <button class="btn" onclick="saveCurrentExam()" style="background: #ff9800; color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; white-space: nowrap;">
                                Lưu
                            </button>
                        </div>
                    </div>
                    
                    <!-- Danh sách bài đã lưu -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                 Bài kiểm tra đã lưu
                            </h4>
                            <span id="examCount" style="background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">0 bài</span>
                        </div>
                        <div id="savedExamsList" style="max-height: 350px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 10px;">
                            <p style="color: #666; text-align: center; padding: 30px;">Đang tải...</p>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- Panel Câu hỏi -->
        <div id="questions" class="panel active">
            
            <!-- Banner hướng dẫn -->
            <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border: 1px solid #667eea40; border-radius: 12px; padding: 15px 20px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 5px 0; color: #667eea;">Đang soạn: <span id="currentExamNameInQuestions" style="color: #333;">--</span></h4>
                <p style="margin: 0; color: #666; font-size: 0.9em;">Các câu hỏi bên dưới sẽ được thêm vào bài kiểm tra đang chọn</p>
            </div>
            
            <h2>Thêm câu hỏi mới</h2>
            
            <h3>️ Thêm câu hỏi thủ công</h3>
            <form id="questionForm">
                <div class="form-group">
                    <label>Nội dung câu hỏi:</label>
                    <textarea id="questionText" placeholder="Nhập nội dung câu hỏi..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Các đáp án (chọn đáp án đúng):</label>
                    <div class="options-grid">
                        <div class="option-input">
                            <input type="radio" name="correct" value="0" checked>
                            <span class="option-label">A</span>
                            <input type="text" id="optionA" placeholder="Đáp án A" required>
                        </div>
                        <div class="option-input">
                            <input type="radio" name="correct" value="1">
                            <span class="option-label">B</span>
                            <input type="text" id="optionB" placeholder="Đáp án B" required>
                        </div>
                        <div class="option-input">
                            <input type="radio" name="correct" value="2">
                            <span class="option-label">C</span>
                            <input type="text" id="optionC" placeholder="Đáp án C" required>
                        </div>
                        <div class="option-input">
                            <input type="radio" name="correct" value="3">
                            <span class="option-label">D</span>
                            <input type="text" id="optionD" placeholder="Đáp án D" required>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Thêm câu hỏi</button>
            </form>

            <div class="question-list">
                <h2 style="margin-top: 40px; margin-bottom: 20px;">Danh sách câu hỏi</h2>
                <div id="questionsList"></div>
            </div>
        </div>

        <!-- Panel Học sinh -->
        <div id="students" class="panel">
            <h2>Quản lý Học sinh</h2>
            
            <!-- Báo cáo chọn nhầm -->
            <div class="settings-card" id="reportsSection" style="display: none;">
                <h3>Báo cáo chọn nhầm (<span id="reportCount">0</span>)</h3>
                <div id="reportsList"></div>
            </div>
            
            <!-- Thống kê học sinh -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="statTotalStudents">0</h3>
                    <p>Tổng học sinh</p>
                </div>
                <div class="stat-card">
                    <h3 id="statSelectedStudents">0</h3>
                    <p>Đang làm bài</p>
                </div>
                <div class="stat-card">
                    <h3 id="statCompletedStudents">0</h3>
                    <p>Đã hoàn thành</p>
                </div>
                <div class="stat-card">
                    <h3 id="statRemainingStudents">0</h3>
                    <p>Chưa làm</p>
                </div>
            </div>
            
            <!-- Thông báo hướng dẫn -->
            <div class="settings-card" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #1976D2; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 5px 0; color: #1565C0;">Danh sách học sinh của lớp: <span id="currentClassNameInStudents" style="color: #333;">--</span></h4>
                        <p style="margin: 0; color: #666; font-size: 0.9em;">Để upload hoặc thay đổi danh sách học sinh, vui lòng vào quản lý Lớp</p>
                    </div>
                    <button class="btn btn-primary" onclick="showClassManager()" style="white-space: nowrap;">
                        Quản lý Lớp
                    </button>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-danger" onclick="resetAllStudents()">Reset tất cả trạng thái</button>
                <button class="btn btn-secondary" onclick="loadStudents()">Làm mới</button>
            </div>
            
            <table class="results-table" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Họ và Tên</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="studentsBody"></tbody>
            </table>
        </div>

        <!-- Panel Kết quả -->
        <div id="results" class="panel">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="statSubmitted">0</h3>
                    <p>Đã nộp bài</p>
                </div>
                <div class="stat-card">
                    <h3 id="statAverage">0</h3>
                    <p>Điểm trung bình</p>
                </div>
                <div class="stat-card">
                    <h3 id="statHighest">0</h3>
                    <p>Điểm cao nhất</p>
                </div>
                <div class="stat-card">
                    <h3 id="statLowest">0</h3>
                    <p>Điểm thấp nhất</p>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="exportResults()">Xuất Excel</button>
                <button class="btn btn-danger" onclick="clearResults()">️ Xóa tất cả kết quả</button>
                <button class="btn btn-secondary" onclick="loadResults()">Làm mới</button>
            </div>

            <table class="results-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Họ tên</th>
                        <th>Lớp</th>
                        <th>STT lớp</th>
                        <th>Điểm</th>
                        <th>Số câu đúng</th>
                        <th>Thời gian làm</th>
                        <th>Nộp lúc</th>
                        <th>Chi tiết</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>

        <!-- Panel Cài đặt -->
        <div id="settings" class="panel">
            <div class="settings-card">
                <h3>Cài đặt bài thi</h3>
                
                <div class="form-group">
                    <label>Tiêu đề bài thi:</label>
                    <input type="text" id="examTitle" value="Bài kiểm tra trắc nghiệm">
                </div>
                
                <div class="form-group">
                    <label>Thời gian làm bài (phút):</label>
                    <input type="number" id="examTime" value="30" min="1" max="180">
                </div>
                
                <div class="setting-row">
                    <div>
                        <strong>Mở bài thi</strong>
                        <p style="color: #666; font-size: 0.9em;">Cho phép học sinh bắt đầu làm bài</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="examOpen" onchange="toggleExam()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <div>
                        <strong>Hiển thị điểm</strong>
                        <p style="color: #666; font-size: 0.9em;">Cho học sinh xem điểm sau khi nộp bài</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showScore" checked onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-row" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 15px;">
                    <div>
                        <strong style="color: #e65100;">Chế độ ÔN TẬP</strong>
                        <p style="color: #bf360c; font-size: 0.9em;">Hiển thị đúng/sai ngay khi học sinh chọn đáp án (không tính điểm)</p>
                        <p style="color: #e65100; font-size: 0.85em; margin-top: 5px; font-style: italic;">* Không giới hạn thời gian làm bài</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="practiceMode" onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-row" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #1976d2; border-radius: 12px; padding: 15px; margin-top: 15px;">
                    <div style="flex: 1;">
                        <strong style="color: #0d47a1;">Mật khẩu bắt đầu làm bài</strong>
                        <p style="color: #1565c0; font-size: 0.9em;">Học sinh phải nhập mật khẩu mới được làm bài (để tất cả bắt đầu cùng lúc)</p>
                        <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                            <input type="text" id="examPassword" placeholder="Nhập mật khẩu..." style="flex: 1; padding: 10px 15px; border: 2px solid #90caf9; border-radius: 8px; font-size: 1em;" onchange="saveSettings()">
                            <button onclick="generateRandomPassword()" style="padding: 10px 15px; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;" title="Tạo mật khẩu ngẫu nhiên">Tao</button>
                            <button onclick="copyPassword()" style="padding: 10px 15px; background: #43a047; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;" title="Sao chép mật khẩu">Copy</button>
                        </div>
                    </div>
                    <label class="toggle-switch" style="margin-left: 15px;">
                        <input type="checkbox" id="requirePassword" onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <button class="btn btn-primary" onclick="saveSettings()" style="margin-top: 20px;">Lưu cài đặt</button>
            </div>

            <div class="settings-card">
                <h3>Hướng dẫn</h3>
                <ol style="line-height: 2; padding-left: 20px;">
                    <li>Thêm câu hỏi vào hệ thống</li>
                    <li>Cài đặt thời gian làm bài</li>
                    <li>Bật "Mở bài thi" để học sinh có thể làm bài</li>
                    <li>Gửi link cho học sinh (xem ở terminal)</li>
                    <li>Theo dõi kết quả real-time tại tab "Kết quả"</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Modal sửa câu hỏi -->
    <div id="editQuestionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(3px);">
        <div style="background: white; border-radius: 16px; width: 95%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">️ Sửa câu hỏi</h3>
                <button onclick="closeEditQuestionModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5em; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 25px;">
                <input type="hidden" id="editQuestionId">
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Nội dung câu hỏi:</label>
                    <textarea id="editQuestionText" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; resize: vertical; box-sizing: border-box;" placeholder="Nhập nội dung câu hỏi..."></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #333;">Các đáp án (chọn đáp án đúng):</label>
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="editCorrect" value="0" id="editCorrect0" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">A</span>
                            <input type="text" id="editOptionA" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;" placeholder="Đáp án A">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="editCorrect" value="1" id="editCorrect1" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">B</span>
                            <input type="text" id="editOptionB" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;" placeholder="Đáp án B">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="editCorrect" value="2" id="editCorrect2" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">C</span>
                            <input type="text" id="editOptionC" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;" placeholder="Đáp án C">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="editCorrect" value="3" id="editCorrect3" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">D</span>
                            <input type="text" id="editOptionD" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;" placeholder="Đáp án D">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                    <button onclick="closeEditQuestionModal()" style="padding: 12px 25px; background: #e0e0e0; color: #333; border: none; border-radius: 10px; font-size: 1em; cursor: pointer; font-weight: 600;">Hủy</button>
                    <button onclick="saveEditQuestion()" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1em; cursor: pointer; font-weight: 600;">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chi tiết -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Chi tiết bài làm</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ========== CUSTOM ALERT & CONFIRM ==========
        (function() {
            // Tạo modal container
            const modalHTML = `
                <div id="customAlertModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;justify-content:center;align-items:center;backdrop-filter:blur(3px);">
                    <div style="background:white;border-radius:16px;padding:0;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:modalPop 0.3s ease;">
                        <div id="alertHeader" style="padding:20px 24px 15px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px;">
                            <span id="alertIcon" style="font-size:28px;"></span>
                            <span id="alertTitle" style="font-size:18px;font-weight:600;color:#333;">Thông báo</span>
                        </div>
                        <div style="padding:20px 24px;">
                            <p id="alertMessage" style="margin:0;color:#555;font-size:15px;line-height:1.6;"></p>
                        </div>
                        <div id="alertButtons" style="padding:15px 24px 20px;display:flex;gap:10px;justify-content:flex-end;"></div>
                    </div>
                </div>
                <style>
                    @keyframes modalPop { from{opacity:0;transform:scale(0.9);} to{opacity:1;transform:scale(1);} }
                </style>`;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            const modal = document.getElementById('customAlertModal');
            const icon = document.getElementById('alertIcon');
            const title = document.getElementById('alertTitle');
            const msg = document.getElementById('alertMessage');
            const btns = document.getElementById('alertButtons');
            
            // Custom alert
            window.showAlert = function(message, type = 'warning') {
                const icons = {warning:'!', error:'X', success:'OK', info:'i'};
                const titles = {warning:'Cảnh báo', error:'Lỗi', success:'Thành công', info:'Thông báo'};
                const colors = {warning:'#f59e0b', error:'#ef4444', success:'#10b981', info:'#3b82f6'};
                
                icon.textContent = icons[type] || '!';
                title.textContent = titles[type] || 'Thông báo';
                title.style.color = colors[type] || '#333';
                msg.innerHTML = message;
                btns.innerHTML = '<button onclick="closeAlert()" style="padding:10px 24px;background:'+colors[type]+';color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;">OK</button>';
                modal.style.display = 'flex';
            };
            
            // Custom confirm
            window.showConfirm = function(message, onYes, onNo) {
                icon.textContent = '?';
                title.textContent = 'Xác nhận';
                title.style.color = '#3b82f6';
                msg.innerHTML = message;
                btns.innerHTML = `
                    <button onclick="closeAlert();(${onNo || function(){}})()" style="padding:10px 20px;background:#e5e7eb;color:#374151;border:none;border-radius:8px;cursor:pointer;font-size:14px;">Hủy</button>
                    <button onclick="closeAlert();(${onYes})()" style="padding:10px 20px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;">Đồng ý</button>`;
                modal.style.display = 'flex';
            };
            
            window.closeAlert = function() { modal.style.display = 'none'; };
            modal.onclick = function(e) { if(e.target === modal) closeAlert(); };
            
            // Override alert
            window.alert = function(msg) { showAlert(msg, msg.includes('Loi') || msg.includes('Lỗi') ? 'error' : msg.includes('Loi') ? 'success' : 'warning'); };
        })();
        // ========== END CUSTOM ALERT ==========
        
        const socket = io();
        let questions = [];
        let results = [];
        let students = [];
        let reports = [];
        
        // Hàm escape HTML để hiển thị các thẻ HTML như text
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Socket events
        socket.on('newResult', (result) => {
            showNotification(`${result.studentName} đã nộp bài - Điểm: ${result.score}`);
            loadResults();
            loadStudents();
        });

        socket.on('resultUpdated', (result) => {
            showNotification(`${result.studentName} đã cập nhật bài - Điểm: ${result.score}`);
            loadResults();
            loadStudents();
        });

        socket.on('questionsUpdated', (total) => {
            document.getElementById('totalQuestions').textContent = total;
            loadQuestions();
        });

        socket.on('studentStatusUpdated', (data) => {
            loadStudents();
        });

        socket.on('studentTabLeave', (data) => {
            showNotification(`${data.name} (STT ${data.stt}) rời trang lần ${data.count}!`, 'warning');
            loadStudents(); // Refresh to show tab leave count
        });

        socket.on('newReport', (report) => {
            showNotification(`Có báo cáo mới: ${report.wrongName} → ${report.correctName}`);
            loadReports();
        });

        socket.on('allStudentsReset', () => {
            showNotification('Đã reset tất cả trạng thái học sinh!');
            loadStudents();
        });

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Load questions
        async function loadQuestions() {
            const res = await fetch('/api/questions');
            questions = await res.json();
            document.getElementById('totalQuestions').textContent = questions.length;
            renderQuestions();
        }

        // Render questions
        function renderQuestions() {
            const container = document.getElementById('questionsList');
            if (questions.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">Chưa có câu hỏi nào. Hãy thêm câu hỏi mới!</p>';
                return;
            }

            container.innerHTML = questions.map((q, i) => `
                <div class="question-item">
                    <div class="question-header">
                        <span class="question-number">Câu ${i + 1}</span>
                        <div class="question-actions">
                            <button class="btn btn-warning" onclick="editQuestion(${i})">️ Sửa</button>
                            <button class="btn btn-danger" onclick="deleteQuestion(${i})">️ Xóa</button>
                        </div>
                    </div>
                    <div class="question-text">${escapeHtml(q.question)}</div>
                    ${q.image ? `<img src="${q.image}" style="max-width: 300px; margin-bottom: 15px; border-radius: 8px;">` : ''}
                    <div class="question-options">
                        ${q.options.map((opt, j) => `
                            <div class="question-option ${j === q.correct ? 'correct' : ''}">
                                <span class="option-label">${String.fromCharCode(65 + j)}</span>
                                ${escapeHtml(opt)}
                                ${j === q.correct ? ' ' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Add question
        document.getElementById('questionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const question = document.getElementById('questionText').value;
            const options = [
                document.getElementById('optionA').value,
                document.getElementById('optionB').value,
                document.getElementById('optionC').value,
                document.getElementById('optionD').value
            ];
            const correct = parseInt(document.querySelector('input[name="correct"]:checked').value);

            const res = await fetch('/api/questions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, options, correct })
            });

            if (res.ok) {
                showNotification('Đã thêm câu hỏi!');
                e.target.reset();
                loadQuestions();
            }
        });

        // Delete question
        async function deleteQuestion(id) {
            if (!confirm('Bạn có chắc muốn xóa câu hỏi này?')) return;
            
            const res = await fetch(`/api/questions/${id}`, { method: 'DELETE' });
            if (res.ok) {
                showNotification('️ Đã xóa câu hỏi!');
                loadQuestions();
            }
        }

        // Edit question - mở modal sửa
        function editQuestion(id) {
            const q = questions[id];
            if (!q) return;
            
            // Điền dữ liệu vào form
            document.getElementById('editQuestionId').value = id;
            document.getElementById('editQuestionText').value = q.question || '';
            document.getElementById('editOptionA').value = q.options[0] || '';
            document.getElementById('editOptionB').value = q.options[1] || '';
            document.getElementById('editOptionC').value = q.options[2] || '';
            document.getElementById('editOptionD').value = q.options[3] || '';
            
            // Chọn đáp án đúng
            const correctRadio = document.getElementById('editCorrect' + q.correct);
            if (correctRadio) correctRadio.checked = true;
            
            // Hiện modal
            document.getElementById('editQuestionModal').style.display = 'flex';
        }
        
        function closeEditQuestionModal() {
            document.getElementById('editQuestionModal').style.display = 'none';
        }
        
        async function saveEditQuestion() {
            const id = document.getElementById('editQuestionId').value;
            const question = document.getElementById('editQuestionText').value.trim();
            const optionA = document.getElementById('editOptionA').value.trim();
            const optionB = document.getElementById('editOptionB').value.trim();
            const optionC = document.getElementById('editOptionC').value.trim();
            const optionD = document.getElementById('editOptionD').value.trim();
            const correct = parseInt(document.querySelector('input[name="editCorrect"]:checked')?.value || '0');
            
            // Validate
            if (!question) {
                alert('Vui lòng nhập nội dung câu hỏi!');
                return;
            }
            if (!optionA || !optionB) {
                alert('Cần ít nhất 2 đáp án!');
                return;
            }
            
            // Tạo mảng options (bỏ qua đáp án trống)
            const options = [optionA, optionB];
            if (optionC) options.push(optionC);
            if (optionD) options.push(optionD);
            
            // Kiểm tra correct có hợp lệ không
            const validCorrect = Math.min(correct, options.length - 1);
            
            const updatedQuestion = {
                question,
                options,
                correct: validCorrect
            };
            
            try {
                const res = await fetch(`/api/questions/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedQuestion)
                });
                
                if (res.ok) {
                    showNotification('Đã cập nhật câu hỏi!');
                    closeEditQuestionModal();
                    loadQuestions();
                } else {
                    alert('Lỗi khi lưu câu hỏi!');
                }
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
        }

        // Load results
        async function loadResults() {
            const res = await fetch('/api/results');
            results = await res.json();
            document.getElementById('totalSubmitted').textContent = results.length;
            renderResults();
            updateStats();
        }

        // Render results
        function renderResults() {
            const tbody = document.getElementById('resultsBody');
            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Chưa có học sinh nào nộp bài</td></tr>';
                return;
            }

            tbody.innerHTML = results.map((r, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${escapeHtml(r.studentName)}</td>
                    <td>${escapeHtml(r.studentClass || '-')}</td>
                    <td>${r.studentSTT || r.studentId || '-'}</td>
                    <td class="${r.score >= 8 ? 'score-high' : r.score >= 5 ? 'score-medium' : 'score-low'}">${r.score}</td>
                    <td>${r.correctCount}/${r.totalQuestions}</td>
                    <td>${r.timeSpent || '-'}</td>
                    <td>${r.submittedAt}</td>
                    <td><button class="btn btn-secondary" onclick="showDetail(${i})">️ Xem</button></td>
                </tr>
            `).join('');
        }

        // Update stats
        function updateStats() {
            document.getElementById('statSubmitted').textContent = results.length;
            
            if (results.length > 0) {
                const scores = results.map(r => r.score);
                const avg = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
                const highest = Math.max(...scores);
                const lowest = Math.min(...scores);
                
                document.getElementById('statAverage').textContent = avg;
                document.getElementById('statHighest').textContent = highest;
                document.getElementById('statLowest').textContent = lowest;
            } else {
                // Reset về "-" khi chưa có kết quả
                document.getElementById('statAverage').textContent = '-';
                document.getElementById('statHighest').textContent = '-';
                document.getElementById('statLowest').textContent = '-';
            }
        }

        // Show detail modal
        function showDetail(index) {
            const r = results[index];
            const content = document.getElementById('detailContent');
            
            // Hàm kiểm tra học sinh có chọn đáp án không
            function hasAnswer(answerIndex) {
                return answerIndex !== undefined && 
                       answerIndex !== null && 
                       answerIndex !== -1 &&
                       !isNaN(answerIndex) &&
                       typeof answerIndex === 'number' &&
                       answerIndex >= 0;
            }
            
            // Hàm format đáp án: hiển thị nội dung text đầy đủ
            // Tìm từ data lưu sẵn hoặc từ câu hỏi hiện tại
            function formatAnswer(answerIndex, answerText, questionIndex, isCorrectAnswer) {
                // Kiểm tra học sinh có chọn đáp án không
                if (!hasAnswer(answerIndex)) {
                    return '<em style="color: #ff9800; font-weight: bold;">Không chọn đáp án</em>';
                }
                
                const letter = String.fromCharCode(65 + answerIndex);
                
                // Ưu tiên dùng text đã lưu
                if (answerText) {
                    return `<strong>${letter}.</strong> ${escapeHtml(answerText)}`;
                }
                
                // Fallback: tìm từ danh sách câu hỏi hiện tại (nếu có)
                if (questions && questions[questionIndex] && questions[questionIndex].options) {
                    const optionText = questions[questionIndex].options[answerIndex];
                    if (optionText) {
                        return `<strong>${letter}.</strong> ${escapeHtml(optionText)}`;
                    }
                }
                
                // Không tìm được text, chỉ hiện chữ cái
                return `<strong>${letter}</strong> <em style="color: #999;">(không có nội dung)</em>`;
            }
            
            // Đếm số câu không trả lời
            const unansweredCount = r.details.filter(d => !hasAnswer(d.studentAnswer)).length;
            
            // Tạo HTML cho chi tiết từng câu
            let detailsHtml = r.details.map((d, i) => {
                const studentDidNotAnswer = !hasAnswer(d.studentAnswer);
                let html = `<div class="detail-item ${d.isCorrect ? 'detail-correct' : 'detail-wrong'}" style="${studentDidNotAnswer ? 'border-left: 4px solid #ff9800;' : ''}">
                    <strong>Câu ${i + 1}:</strong> ${escapeHtml(d.question)}<br>
                    <div style="margin-top: 5px;">
                        <span style="color: ${d.isCorrect ? '#2e7d32' : (studentDidNotAnswer ? '#ff9800' : '#c62828')};">
                            HS chọn: ${formatAnswer(d.studentAnswer, d.studentAnswerText, i, false)}
                        </span>
                    </div>`;
                
                if (!d.isCorrect) {
                    html += `<div style="margin-top: 3px;">
                        <span style="color: #2e7d32;">
                            Đáp án đúng: ${formatAnswer(d.correctAnswer, d.correctAnswerText, i, true)}
                        </span>
                    </div>`;
                }
                
                html += `</div>`;
                return html;
            }).join('');
            
            content.innerHTML = `
                <p><strong>Họ tên:</strong> ${escapeHtml(r.studentName)}</p>
                <p><strong>Lớp:</strong> ${escapeHtml(r.studentClass || '-')}</p>
                <p><strong>STT:</strong> ${r.studentSTT || r.studentId || '-'}</p>
                <p><strong>Điểm:</strong> ${r.score} (${r.correctCount}/${r.totalQuestions} câu đúng)</p>
                ${unansweredCount > 0 ? `<p style="color: #ff9800; font-weight: bold;">Có ${unansweredCount} câu không chọn đáp án!</p>` : ''}
                <hr style="margin: 15px 0;">
                <h4>Chi tiết từng câu:</h4>
                ${detailsHtml}
            `;
            
            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // Export results
        function exportResults() {
            window.location.href = '/api/results/export';
        }

        // Download sample Excel template
        function downloadSampleExcel(type) {
            if (type === 1) {
                window.location.href = '/api/sample-excel';
            } else if (type === 2) {
                window.location.href = '/api/sample-excel-2';
            } else if (type === 3) {
                window.location.href = '/api/sample-excel-3';
            }
        }

        // Upload danh sách học sinh
        async function uploadStudentList(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Kiểm tra định dạng file
            const validExtensions = ['.xlsx', '.xls'];
            const fileName = file.name.toLowerCase();
            const isValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!isValidExtension) {
                showNotification('Chỉ chấp nhận file Excel (.xlsx hoặc .xls)!', 'error');
                input.value = '';
                return;
            }
            
            showNotification('Đang tải lên...', 'info');
            
            try {
                const res = await fetch('/api/upload-students', {
                    method: 'POST',
                    body: file,
                    headers: {
                        'Content-Type': 'application/octet-stream'
                    }
                });
                
                const result = await res.json();
                
                if (result.success) {
                    showNotification(`${result.message}`, 'success');
                    loadStudents();
                    
                    // Hiện cảnh báo nếu có
                    if (result.warnings && result.warnings.length > 0) {
                        setTimeout(() => {
                            alert('Một số dòng có lỗi:\n\n' + result.warnings.join('\n'));
                        }, 500);
                    }
                } else {
                    let errorMsg = result.error || 'Lỗi không xác định';
                    if (result.details && result.details.length > 0) {
                        errorMsg += '\n\nChi tiết:\n' + result.details.slice(0, 5).join('\n');
                        if (result.details.length > 5) {
                            errorMsg += `\n... và ${result.details.length - 5} lỗi khác`;
                        }
                    }
                    showNotification('' + result.error, 'error');
                    alert('Lỗi định dạng file!\n\n' + errorMsg);
                }
            } catch (err) {
                console.error('Lỗi upload:', err);
                showNotification('Lỗi kết nối server!', 'error');
            }
            
            // Reset input để có thể upload lại cùng file
            input.value = '';
        }

        // Clear results
        async function clearResults() {
            if (!confirm('Bạn có chắc muốn xóa TẤT CẢ kết quả?')) return;
            
            const res = await fetch('/api/results', { method: 'DELETE' });
            if (res.ok) {
                showNotification('️ Đã xóa tất cả kết quả!');
                loadResults();
            }
        }

        // Settings
        async function loadSettings() {
            const res = await fetch('/api/settings');
            const settings = await res.json();
            
            document.getElementById('examTitle').value = settings.title;
            document.getElementById('examTime').value = settings.timeLimit;
            document.getElementById('examOpen').checked = settings.isOpen;
            document.getElementById('showScore').checked = settings.showScore !== false;
            document.getElementById('practiceMode').checked = settings.practiceMode === true;
            document.getElementById('examPassword').value = settings.examPassword || '';
            document.getElementById('requirePassword').checked = settings.requirePassword === true;
            updateExamStatus(settings.isOpen);
        }

        async function saveSettings() {
            const settings = {
                title: document.getElementById('examTitle').value,
                timeLimit: parseInt(document.getElementById('examTime').value),
                isOpen: document.getElementById('examOpen').checked,
                showScore: document.getElementById('showScore').checked,
                practiceMode: document.getElementById('practiceMode').checked,
                examPassword: document.getElementById('examPassword').value,
                requirePassword: document.getElementById('requirePassword').checked
            };

            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (res.ok) {
                showNotification('Đã lưu cài đặt!');
            }
        }
        
        // Tạo mật khẩu ngẫu nhiên
        function generateRandomPassword() {
            const chars = '0123456789ABCDEFGHJKLMNPQRSTUVWXYZ'; // Bỏ O, I để tránh nhầm
            let password = '';
            for (let i = 0; i < 6; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('examPassword').value = password;
            document.getElementById('requirePassword').checked = true;
            saveSettings();
            showNotification('Mật khẩu mới: ' + password);
        }
        
        // Sao chép mật khẩu
        function copyPassword() {
            const password = document.getElementById('examPassword').value;
            if (!password) {
                showNotification('Chưa có mật khẩu!', 'warning');
                return;
            }
            navigator.clipboard.writeText(password).then(() => {
                showNotification('Đã sao chép: ' + password);
            }).catch(() => {
                showNotification('Không thể sao chép', 'error');
            });
        }

        async function toggleExam() {
            const isOpen = document.getElementById('examOpen').checked;
            updateExamStatus(isOpen);
            await saveSettings();
        }

        function updateExamStatus(isOpen) {
            const badge = document.getElementById('examStatus');
            if (isOpen) {
                badge.textContent = 'Đang mở thi';
                badge.className = 'status-badge status-open';
            } else {
                badge.textContent = 'Chưa mở thi';
                badge.className = 'status-badge status-closed';
            }
        }

        // Notification
        // ========== HỆ THỐNG THÔNG BÁO ĐẸP ==========
        function showNotification(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            
            // Xác định loại thông báo
            let icon = '!';
            let title = 'Thành công';
            if (message.includes('Loi') || type === 'error') {
                type = 'error';
                icon = '!';
                title = 'Lỗi';
                
            } else if (message.includes('Loi') || type === 'warning') {
                type = 'warning';
                icon = '!';
                title = 'Cảnh báo';
                
            } else if (message.includes('Loi') || type === 'info') {
                type = 'info';
                icon = '!';
                title = 'Thông tin';
                
            } else {
                
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Alert modal đẹp - thay thế alert() mặc định
        function showAlert(message, type = 'warning', callback = null) {
            // Xác định loại
            let icon = '!';
            let title = 'Thông báo';
            let btnClass = 'primary';
            
            if (message.includes('Loi') || type === 'error') {
                type = 'error';
                icon = '!';
                title = 'Có lỗi xảy ra';
                
            } else if (message.includes('Loi') || type === 'warning') {
                type = 'warning';
                icon = '!';
                title = 'Cảnh báo';
                
            } else if (message.includes('Loi') || type === 'success') {
                type = 'success';
                icon = '!';
                title = 'Thành công';
                
            } else if (type === 'info') {
                icon = '!';
                title = 'Thông tin';
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'alert-modal-overlay';
            overlay.innerHTML = `
                <div class="alert-modal">
                    <div class="alert-modal-header">
                        <div class="alert-modal-icon ${type}">${icon}</div>
                        <div class="alert-modal-title">${title}</div>
                    </div>
                    <div class="alert-modal-body">${message}</div>
                    <div class="alert-modal-footer">
                        <button class="alert-modal-btn primary" onclick="this.closest('.alert-modal-overlay').remove(); ${callback ? 'window.__alertCallback && window.__alertCallback()' : ''}">OK</button>
                    </div>
                </div>
            `;
            
            if (callback) {
                window.__alertCallback = callback;
            }
            
            document.body.appendChild(overlay);
            
            // Click outside để đóng
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
            
            // ESC để đóng
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        // Confirm modal đẹp - thay thế confirm() mặc định
        function showConfirm(message, onConfirm, onCancel = null) {
            const overlay = document.createElement('div');
            overlay.className = 'alert-modal-overlay';
            overlay.innerHTML = `
                <div class="alert-modal">
                    <div class="alert-modal-header">
                        <div class="alert-modal-icon warning"></div>
                        <div class="alert-modal-title">Xác nhận</div>
                    </div>
                    <div class="alert-modal-body">${message}</div>
                    <div class="alert-modal-footer">
                        <button class="alert-modal-btn secondary" id="confirmCancel">Hủy</button>
                        <button class="alert-modal-btn primary" id="confirmOK">Đồng ý</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            overlay.querySelector('#confirmOK').onclick = () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            };
            
            overlay.querySelector('#confirmCancel').onclick = () => {
                overlay.remove();
                if (onCancel) onCancel();
            };
            
            // Click outside để đóng
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                    if (onCancel) onCancel();
                }
            });
        }

        // ========== QUẢN LÝ SESSION (LỚP + BÀI) ==========
        let currentSession = { classId: null, className: null, examId: null, examName: null };
        let currentResultCount = 0; // Theo dõi số kết quả hiện tại
        
        // Kiểm tra và nhắc nhở xuất điểm trước khi chuyển
        function checkAndConfirmSwitch(type, newName) {
            if (currentResultCount > 0) {
                const currentInfo = type === 'class' 
                    ? `lớp "${currentSession.className || 'hiện tại'}"` 
                    : `bài "${currentSession.examName || 'hiện tại'}"`;
                
                const message = `⚠️ CẢNH BÁO!\n\n` +
                    `Bạn có ${currentResultCount} kết quả chưa xuất file cho ${currentInfo}.\n\n` +
                    `Bạn có muốn:\n` +
                    `• Nhấn "OK" để tiếp tục chuyển (dữ liệu vẫn được lưu, có thể xem lại trong "Kết quả đã lưu")\n` +
                    `• Nhấn "Cancel" để quay lại xuất điểm trước`;
                
                return confirm(message);
            }
            return true;
        }
        
        // Cập nhật hiển thị session
        async function updateSessionDisplay() {
            try {
                const res = await fetch('/api/session');
                const data = await res.json();
                currentSession = data.currentSession;
                
                // Cập nhật hiển thị lớp
                document.getElementById('currentClassName').textContent = currentSession.className || 'Chưa chọn lớp';
                document.getElementById('currentClassInfo').textContent = data.studentCount + ' học sinh';
                
                // Cập nhật hiển thị bài kiểm tra
                document.getElementById('currentExamName').textContent = currentSession.examName || 'Chưa chọn bài';
                
                // Cập nhật số câu hỏi từ API
                const qRes = await fetch('/api/questions');
                const qs = await qRes.json();
                document.getElementById('currentExamInfo').textContent = (qs.length || 0) + ' câu hỏi';
                
                // Cập nhật thống kê
                document.getElementById('sessionResultCount').textContent = data.resultCount;
                currentResultCount = data.resultCount; // Lưu để kiểm tra khi chuyển
                
                // Cập nhật các banner trong các tab
                const classNameInStudents = document.getElementById('currentClassNameInStudents');
                if (classNameInStudents) {
                    classNameInStudents.textContent = currentSession.className || 'Chưa chọn lớp';
                }
                
                const examNameInQuestions = document.getElementById('currentExamNameInQuestions');
                if (examNameInQuestions) {
                    examNameInQuestions.textContent = currentSession.examName || 'Chưa chọn bài';
                }
                
            } catch (err) {
                console.error('Lỗi cập nhật session:', err);
            }
        }
        
        // ========== QUẢN LÝ LỚP ==========
        function showClassManager() {
            document.getElementById('classManagerModal').style.display = 'flex';
            loadClasses();
        }
        
        function hideClassManager() {
            document.getElementById('classManagerModal').style.display = 'none';
        }
        
        async function loadClasses() {
            try {
                const res = await fetch('/api/classes');
                const data = await res.json();
                
                const listDiv = document.getElementById('classesList');
                document.getElementById('classCount').textContent = data.classes.length + ' lớp';
                
                if (data.classes.length === 0) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;"></div>
                            <p style="margin: 0;">Chưa có lớp nào</p>
                            <p style="margin: 10px 0 0 0; font-size: 0.9em; opacity: 0.7;">Tạo lớp mới để quản lý học sinh và kết quả</p>
                        </div>
                    `;
                    return;
                }
                
                listDiv.innerHTML = data.classes.map(cls => `
                    <div style="padding: 15px 18px; background: ${cls.id === currentSession.classId ? 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)' : 'white'}; border-bottom: 1px solid #eee; ${cls.id === currentSession.classId ? 'border-left: 4px solid #1976D2;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 1.3em;">${cls.id === currentSession.classId ?'(Nu)' : ''}</span>
                                    <div>
                                        <strong style="font-size: 1.05em; color: #333;">${escapeHtml(cls.name)}</strong>
                                        ${cls.id === currentSession.classId ? '<span style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.7em; margin-left: 10px; font-weight: bold;">ĐANG DÙNG</span>' : ''}
                                        <div style="color: #888; font-size: 0.85em; margin-top: 3px;">
                                            ${cls.studentCount || 0} học sinh
                                            ${cls.studentFile ? '' : '<span style="color: #ff9800;">Chưa upload danh sách</span>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <!-- Nút upload danh sách -->
                                <label style="background: #e3f2fd; color: #1565c0; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em;" title="Upload danh sách học sinh">
                                    DS
                                    <input type="file" accept=".xlsx,.xls" style="display: none;" onchange="uploadClassStudents('${cls.id}', this)">
                                </label>
                                ${cls.id !== currentSession.classId ? `
                                    <button onclick="switchToClass('${cls.id}')" style="background: #1976D2; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                        Chọn
                                    </button>
                                    <button onclick="deleteClass('${cls.id}')" style="background: #ffebee; color: #c62828; border: none; padding: 10px 12px; border-radius: 8px; cursor: pointer;" title="Xóa lớp">
                                        ️
                                    </button>
                                ` : `
                                    <span style="color: #1976D2; font-weight: bold; padding: 10px;">Đang chọn</span>
                                `}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Lỗi tải danh sách lớp:', err);
            }
        }
        
        // Upload danh sách học sinh cho lớp
        async function uploadClassStudents(classId, input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const res = await fetch(`/api/classes/${classId}/students`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification('' + result.message);
                    loadClasses();
                    // Nếu là lớp đang chọn, reload students
                    if (classId === currentSession.classId) {
                        loadStudents();
                        updateSessionDisplay();
                    }
                } else {
                    alert('' + result.error);
                }
            } catch (err) {
                alert('Lỗi upload: ' + err.message);
            }
            
            input.value = ''; // Reset input
        }
        
        async function createNewClass() {
            const name = document.getElementById('newClassName').value.trim();
            if (!name) {
                alert('Vui lòng nhập tên lớp!');
                document.getElementById('newClassName').focus();
                return;
            }
            
            try {
                const res = await fetch('/api/classes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification('' + result.message);
                    document.getElementById('newClassName').value = '';
                    loadClasses();
                } else {
                    alert('' + result.error);
                }
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
        }
        
        async function switchToClass(classId) {
            // Kiểm tra nhắc nhở xuất điểm
            if (!checkAndConfirmSwitch('class')) {
                return;
            }
            
            try {
                const res = await fetch('/api/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ classId })
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification('Đã chọn lớp: ' + result.currentSession.className);
                    hideClassManager();
                    updateSessionDisplay();
                    loadStudents();
                    loadResults();
                } else {
                    alert('' + result.error);
                }
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
        }
        
        async function deleteClass(classId) {
            if (!confirm('️ Xóa lớp này?\n\nHành động này không thể hoàn tác!')) return;
            
            try {
                const res = await fetch(`/api/classes/${classId}`, { method: 'DELETE' });
                const result = await res.json();
                
                if (result.success) {
                    showNotification('️ Đã xóa lớp');
                    loadClasses();
                } else {
                    alert('' + result.error);
                }
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
        }

        // ========== QUẢN LÝ BÀI KIỂM TRA ==========
        
        function showExamManager() {
            document.getElementById('examManagerModal').style.display = 'flex';
            loadSavedExams();
        }
        
        function hideExamManager() {
            document.getElementById('examManagerModal').style.display = 'none';
        }
        
        async function loadSavedExams() {
            try {
                const res = await fetch('/api/exams');
                const data = await res.json();
                
                const listDiv = document.getElementById('savedExamsList');
                document.getElementById('examCount').textContent = data.exams.length + ' bài';
                
                if (data.exams.length === 0) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;"></div>
                            <p style="margin: 0;">Chưa có bài kiểm tra nào được lưu</p>
                            <p style="margin: 10px 0 0 0; font-size: 0.9em; opacity: 0.7;">Lưu bài kiểm tra để dùng lại cho các lớp khác</p>
                        </div>
                    `;
                    return;
                }
                
                listDiv.innerHTML = data.exams.map(exam => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 18px; background: ${exam.id === currentSession.examId ? 'linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%)' : 'white'}; border-bottom: 1px solid #eee; ${exam.id === currentSession.examId ? 'border-left: 4px solid #667eea;' : ''}">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.3em;">${exam.id === currentSession.examId ?'(Nu)' : ''}</span>
                                <div>
                                    <strong style="font-size: 1.05em; color: #333;">${escapeHtml(exam.name)}</strong>
                                    ${exam.id === currentSession.examId ? '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.7em; margin-left: 10px; font-weight: bold;">ĐANG DÙNG</span>' : ''}
                                    <div style="color: #888; font-size: 0.85em; margin-top: 3px;">${exam.questionCount} câu hỏi</div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${exam.id !== currentSession.examId ? `
                                <button onclick="switchToExam('${exam.id}')" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#5a6fd6'" onmouseout="this.style.background='#667eea'">
                                    Sử dụng
                                </button>
                                <button onclick="deleteExam('${exam.id}')" style="background: #ffebee; color: #c62828; border: none; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ffcdd2'" onmouseout="this.style.background='#ffebee'" title="Xóa bài này">
                                    ️
                                </button>
                            ` : `
                                <span style="color: #667eea; font-weight: bold; padding: 10px;">Đang sử dụng</span>
                            `}
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Lỗi tải danh sách bài kiểm tra:', err);
            }
        }
        
        async function createNewExam() {
            const name = document.getElementById('newExamName').value.trim();
            if (!name) {
                alert('Vui lòng nhập tên bài kiểm tra!');
                document.getElementById('newExamName').focus();
                return;
            }
            
            if (!confirm(`Tạo bài kiểm tra mới: "${name}"\n\nBài mới sẽ được lưu vào danh sách.\nBài đang dùng KHÔNG thay đổi.\nTiếp tục?`)) return;
            
            try {
                const res = await fetch('/api/exams/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification(`Đã tạo bài "${name}" (chưa sử dụng)`);
                    document.getElementById('newExamName').value = '';
                    loadSavedExams(); // Chỉ load lại danh sách bài
                } else {
                    alert('' + result.error);
                }
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
        }
        
        async function saveCurrentExam() {
            let name = document.getElementById('saveExamName').value.trim();
            if (!name) {
                name = document.getElementById('currentExamName').textContent;
                if (!name || name === 'Chưa chọn bài') {
                    alert('Vui lòng nhập tên để lưu!');
                    document.getElementById('saveExamName').focus();
                    return;
                }
            }
            
            try {
                const res = await fetch('/api/exams/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification('Đã lưu: ' + name);
                    document.getElementById('saveExamName').value = '';
                    loadSavedExams();
                    updateSessionDisplay();
                } else {
                    alert('' + result.error);
                }
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
        }
        
        async function switchToExam(examId) {
            // Kiểm tra nhắc nhở xuất điểm
            if (!checkAndConfirmSwitch('exam')) {
                return;
            }
            
            try {
                const res = await fetch('/api/exams/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ examId, resetStudents: false })
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification('Đã chuyển sang: ' + result.examName);
                    hideExamManager();
                    loadQuestions();
                    loadResults();
                    loadStudents();
                    loadSettings();
                    updateSessionDisplay();
                } else {
                    alert('' + result.error);
                }
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
        }
        
        async function deleteExam(examId) {
            if (!confirm('️ Xóa bài kiểm tra này?\n\nHành động này không thể hoàn tác!')) return;
            
            try {
                const res = await fetch(`/api/exams/${examId}`, { method: 'DELETE' });
                const result = await res.json();
                
                if (result.success) {
                    showNotification('️ Đã xóa bài kiểm tra');
                    loadSavedExams();
                } else {
                    alert('' + result.error);
                }
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
        }
        
        // Tạo bài kiểm tra mới từ file Word hoặc JSON (KHÔNG chuyển sang dùng)
        async function createExamFromFile(input, fileType) {
            const file = input.files[0];
            if (!file) return;
            
            const examName = document.getElementById('newExamName').value.trim();
            if (!examName) {
                alert('Vui lòng nhập tên bài kiểm tra trước khi upload!');
                document.getElementById('newExamName').focus();
                input.value = '';
                return;
            }
            
            try {
                // Bước 1: Tạo bài kiểm tra mới (KHÔNG chuyển sang dùng)
                const createRes = await fetch('/api/exams/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: examName })
                });
                
                const createResult = await createRes.json();
                if (!createResult.success) {
                    alert('' + createResult.error);
                    input.value = '';
                    return;
                }
                
                const newExamId = createResult.examId;
                
                // Bước 2: Import câu hỏi vào bài vừa tạo (không ảnh hưởng bài đang dùng)
                const formData = new FormData();
                formData.append('file', file);
                
                const uploadUrl = fileType === 'json' 
                    ? `/api/exams/${newExamId}/import-json` 
                    : `/api/exams/${newExamId}/import-word`;
                
                const uploadRes = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData
                });
                
                const uploadResult = await uploadRes.json();
                if (uploadResult.success) {
                    const count = uploadResult.count || 0;
                    showNotification(`Đã tạo "${examName}" với ${count} câu hỏi (chưa sử dụng)`);
                } else {
                    showNotification('Đã tạo bài nhưng import lỗi: ' + uploadResult.error);
                }
                
                // Cập nhật danh sách bài - KHÔNG thay đổi bài đang dùng
                document.getElementById('newExamName').value = '';
                loadSavedExams(); // Chỉ load lại danh sách bài đã lưu
                
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
            
            input.value = '';
        }
        
        function updateCurrentExamDisplay() {
            fetch('/api/questions')
                .then(res => res.json())
                .then(qs => {
                    document.getElementById('currentExamInfo').textContent = qs.length + ' câu hỏi';
                });
            // Cập nhật thống kê session
            updateStudentStats();
        }
        
        // Listen for exam switch events
        socket.on('examSwitched', (data) => {
            showNotification(`Đã chuyển sang: ${data.examName}`);
            loadQuestions();
            loadResults();
            loadSettings();
            updateSessionDisplay();
        });
        
        // Listen for session change events
        socket.on('sessionChanged', (session) => {
            currentSession = session;
            updateSessionDisplay();
        });
        
        // ========== END QUẢN LÝ BÀI KIỂM TRA ==========

        // Initialize
        loadQuestions();
        loadResults();
        loadSettings();
        loadStudents();
        loadReports();
        updateSessionDisplay(); // Thay vì updateCurrentExamDisplay

        // Load students
        async function loadStudents() {
            try {
                const res = await fetch('/api/students');
                students = await res.json();
                renderStudents();
                updateStudentStats();
            } catch (err) {
                console.error('Lỗi tải danh sách học sinh:', err);
            }
        }

        // Render students
        function renderStudents() {
            const tbody = document.getElementById('studentsBody');
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Chưa có danh sách học sinh. Hãy đặt file danhsach.xlsx vào thư mục danhsach/</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(s => {
                let statusClass = 'available';
                let statusText = 'Chưa chọn';
                
                if (s.status.completed) {
                    statusClass = 'completed';
                    statusText = 'Đã hoàn thành';
                } else if (s.status.canRetry) {
                    statusClass = 'can-retry';
                    statusText = 'Được làm lại';
                } else if (s.status.selected) {
                    statusClass = 'selected';
                    statusText = 'Đang làm bài';
                }

                const actions = [];
                if (s.status.completed && !s.status.canRetry) {
                    actions.push(`<button class="btn btn-warning" onclick="allowRetry(${s.stt})">Cho làm lại</button>`);
                }
                if (s.status.selected && !s.status.completed) {
                    actions.push(`<button class="btn btn-danger" onclick="forceDeselect(${s.stt})">Hủy chọn</button>`);
                }
                
                // Show tab leave warning
                const tabLeaveCount = s.status.tabLeaveCount || 0;
                const tabLeaveWarning = tabLeaveCount > 0 
                    ? `<span style="color: #dc3545; font-weight: bold; margin-left: 8px;" title="Rời trang ${tabLeaveCount} lần">${tabLeaveCount}</span>` 
                    : '';

                return `
                    <tr>
                        <td>${s.stt}</td>
                        <td>${escapeHtml(s.ho)} ${escapeHtml(s.ten)} ${s.nu === 'X' ? '<span style="color: #e91e63; font-weight: bold;" title="Nữ">(N)</span>' : ''}</td>
                        <td><span class="student-status ${statusClass}">${statusText}</span>${tabLeaveWarning}</td>
                        <td>${actions.join(' ') || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Update student stats
        function updateStudentStats() {
            const total = students.length;
            const selected = students.filter(s => s.status.selected && !s.status.completed).length;
            const completed = students.filter(s => s.status.completed).length;
            const remaining = total - completed;

            document.getElementById('statTotalStudents').textContent = total;
            document.getElementById('statSelectedStudents').textContent = selected;
            document.getElementById('statCompletedStudents').textContent = completed;
            document.getElementById('statRemainingStudents').textContent = remaining;
            
            // Cập nhật thống kê session
            document.getElementById('sessionInProgressCount').textContent = selected;
            document.getElementById('sessionCompletedCount').textContent = completed;
        }

        // Allow retry
        async function allowRetry(stt) {
            if (!confirm('Cho phép học sinh này làm lại bài?')) return;

            try {
                const res = await fetch('/api/allow-retry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stt })
                });

                if (res.ok) {
                    showNotification('Đã cho phép làm lại!');
                    loadStudents();
                }
            } catch (err) {
                showNotification('Lỗi: ' + err.message);
            }
        }

        // Force deselect
        async function forceDeselect(stt) {
            if (!confirm('Hủy chọn của học sinh này?')) return;

            // Tìm socketId của học sinh
            const student = students.find(s => s.stt == stt);
            if (!student || !student.status.selectedBy) return;

            try {
                const res = await fetch('/api/deselect-student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stt, socketId: student.status.selectedBy })
                });

                if (res.ok) {
                    showNotification('Đã hủy chọn!');
                    loadStudents();
                }
            } catch (err) {
                showNotification('Lỗi: ' + err.message);
            }
        }

        // Reset all students
        async function resetAllStudents() {
            if (!confirm('Reset TẤT CẢ trạng thái học sinh?\n\nĐiều này sẽ:\n- Hủy tất cả lựa chọn hiện tại\n- Cho phép tất cả học sinh chọn lại\n- KHÔNG xóa kết quả bài thi')) return;

            try {
                const res = await fetch('/api/reset-all-students', { method: 'POST' });

                if (res.ok) {
                    showNotification('Đã reset tất cả!');
                    loadStudents();
                }
            } catch (err) {
                showNotification('Lỗi: ' + err.message);
            }
        }

        // Load reports
        async function loadReports() {
            try {
                const res = await fetch('/api/reports');
                reports = await res.json();
                renderReports();
            } catch (err) {
                console.error('Lỗi tải báo cáo:', err);
            }
        }

        // Render reports
        function renderReports() {
            const section = document.getElementById('reportsSection');
            const container = document.getElementById('reportsList');
            const countEl = document.getElementById('reportCount');

            countEl.textContent = reports.length;

            if (reports.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = reports.map(r => `
                <div class="report-item">
                    <div class="report-info">
                        <strong>Báo cáo lúc:</strong> ${r.createdAt}<br>
                        <strong>Đã chọn nhầm:</strong> ${escapeHtml(r.wrongName)} (STT ${r.wrongSTT})<br>
                        <strong>Tên đúng:</strong> ${escapeHtml(r.correctName)} (STT ${r.correctSTT})<br>
                        ${r.reason ? `<strong>Lý do:</strong> ${escapeHtml(r.reason)}` : ''}
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-success" onclick="approveReport(${r.id})">Duyệt</button>
                        <button class="btn btn-danger" onclick="rejectReport(${r.id})">Từ chối</button>
                    </div>
                </div>
            `).join('');
        }

        // Approve report
        async function approveReport(reportId) {
            try {
                const res = await fetch('/api/approve-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportId })
                });

                if (res.ok) {
                    showNotification('Đã duyệt báo cáo!');
                    loadReports();
                    loadStudents();
                }
            } catch (err) {
                showNotification('Lỗi: ' + err.message);
            }
        }

        // Reject report
        async function rejectReport(reportId) {
            try {
                const res = await fetch('/api/reject-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportId })
                });

                if (res.ok) {
                    showNotification('Đã từ chối báo cáo!');
                    loadReports();
                }
            } catch (err) {
                showNotification('Lỗi: ' + err.message);
            }
        }

        // Import Word file
        async function importWord(input) {
            const file = input.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('importStatus');
            statusDiv.innerHTML = '<span style="color: #667eea;">Đang xử lý file...</span>';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const res = await fetch('/api/import-word', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await res.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `<span style="color: #28a745;">Đã import ${result.imported} câu hỏi! Tổng: ${result.total} câu</span>`;
                    loadQuestions();
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">${result.error}</span>`;
                }
            } catch (err) {
                statusDiv.innerHTML = `<span style="color: #dc3545;">Lỗi: ${err.message}</span>`;
            }
            
            input.value = ''; // Reset input
        }

        // Download sample JSON
        function downloadSampleJSON() {
            const sampleQuestions = [
                {
                    "question": "Thủ đô của Việt Nam là gì?",
                    "options": ["Hà Nội", "Hồ Chí Minh", "Đà Nẵng", "Huế"],
                    "correct": 0
                },
                {
                    "question": "1 + 1 = ?",
                    "options": ["1", "2", "3", "4"],
                    "correct": 1
                },
                {
                    "question": "Thẻ HTML nào dùng để tạo tiêu đề lớn nhất?",
                    "options": ["<h6>", "<h1>", "<header>", "<title>"],
                    "correct": 1
                }
            ];
            
            const dataStr = JSON.stringify(sampleQuestions, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mau-cau-hoi.json';
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Import JSON file
        async function importJSON(input) {
            const file = input.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('importStatus');
            statusDiv.innerHTML = '<span style="color: #667eea;">Đang xử lý file JSON...</span>';
            
            try {
                const text = await file.text();
                let jsonData;
                
                try {
                    jsonData = JSON.parse(text);
                } catch (parseErr) {
                    statusDiv.innerHTML = '<span style="color: #dc3545;">File JSON không hợp lệ. Kiểm tra cú pháp JSON.</span>';
                    input.value = '';
                    return;
                }
                
                const res = await fetch('/api/upload-questions-json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonData)
                });
                
                const result = await res.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `<span style="color: #28a745;">Đã import ${result.imported} câu hỏi! Tổng: ${result.total} câu</span>`;
                    loadQuestions();
                    
                    if (result.warnings && result.warnings.length > 0) {
                        setTimeout(() => {
                            alert('Một số câu hỏi có lỗi:\n\n' + result.warnings.slice(0, 5).join('\n') + 
                                  (result.warnings.length > 5 ? `\n... và ${result.warnings.length - 5} lỗi khác` : ''));
                        }, 500);
                    }
                } else {
                    let errorMsg = result.error;
                    if (result.details && result.details.length > 0) {
                        errorMsg += '\n\n' + result.details.slice(0, 3).join('\n');
                    }
                    statusDiv.innerHTML = `<span style="color: #dc3545;">${result.error}</span>`;
                    alert('Lỗi import:\n\n' + errorMsg);
                }
            } catch (err) {
                statusDiv.innerHTML = `<span style="color: #dc3545;">Lỗi: ${err.message}</span>`;
            }
            
            input.value = ''; // Reset input
        }
    </script>
    
    <!-- Footer Copyright -->
    <footer style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); color: #e8e8e8; padding: 25px 20px; margin-top: 40px; border-top: 3px solid #667eea;">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px;">
            <div style="flex: 1; min-width: 250px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <img src="/logo.svg" alt="Logo" style="width: 32px; height: 32px;">
                    <span style="font-size: 1.2em; font-weight: bold; color: #667eea;">Trắc Nghiệm LAN</span>
                </div>
                <div style="font-size: 0.85em; color: #aaa;">
                    Hệ thống thi trắc nghiệm mạng LAN
                </div>
            </div>
            <div style="flex: 1; min-width: 250px; text-align: center;">
                <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">
                    Phát triển bởi <span style="color: #ffd700;">Nguyễn Quang Hùng</span>
                </div>
                <div style="display: flex; justify-content: center; gap: 25px; flex-wrap: wrap;">
                    <a href="mailto:nqh2610@gmail.com" style="color: #4fc3f7; text-decoration: none; display: flex; align-items: center; gap: 5px; transition: color 0.3s;">
                        <span style="font-size: 1.2em;">️</span> nqh2610@gmail.com
                    </a>
                    <a href="tel:0976385309" style="color: #81c784; text-decoration: none; display: flex; align-items: center; gap: 5px; transition: color 0.3s;">
                         0976.385.309
                    </a>
                </div>
            </div>
            <div style="flex: 1; min-width: 150px; text-align: right;">
                <div style="font-size: 0.85em; color: #888;">
                    © 2025 All rights reserved
                </div>
                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                    Version 1.0
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
