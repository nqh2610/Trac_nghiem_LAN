<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Tr·∫Øc nghi·ªám - Gi√°o vi√™n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        header h1 {
            color: #333;
            font-size: 1.8em;
        }
        
        .header-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .status-open {
            background: #d4edda;
            color: #155724;
        }
        
        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 0;
        }
        
        .tab {
            padding: 12px 25px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: white;
            color: #667eea;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        
        .panel {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 0 15px 15px 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .panel.active {
            display: block;
        }
        
        /* Form th√™m c√¢u h·ªèi */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .option-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option-input input[type="radio"] {
            width: auto;
        }
        
        .option-input input[type="text"] {
            flex: 1;
        }
        
        .option-label {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        /* Danh s√°ch c√¢u h·ªèi */
        .question-list {
            margin-top: 30px;
        }
        
        .question-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .question-number {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .question-actions {
            display: flex;
            gap: 10px;
        }
        
        .question-actions button {
            padding: 5px 15px;
            font-size: 0.85em;
        }
        
        .question-text {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #333;
        }
        
        .question-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .question-option {
            padding: 10px 15px;
            background: white;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .question-option.correct {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        
        /* B·∫£ng k·∫øt qu·∫£ */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th, .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .results-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .score-high {
            color: #28a745;
            font-weight: bold;
        }
        
        .score-medium {
            color: #ffc107;
            font-weight: bold;
        }
        
        .score-low {
            color: #dc3545;
            font-weight: bold;
        }
        
        /* C√†i ƒë·∫∑t */
        .settings-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .settings-card h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .setting-row:last-child {
            border-bottom: none;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 30px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: #28a745;
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            opacity: 0.9;
        }
        
        /* Th√¥ng b√°o real-time */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .options-grid, .question-options {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                text-align: center;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .import-section {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px dashed #667eea;
        }

        .import-section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .import-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .file-label {
            cursor: pointer;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .detail-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .detail-correct {
            background: #d4edda;
        }

        .detail-wrong {
            background: #f8d7da;
        }

        /* Student status badges */
        .student-status {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .student-status.available {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .student-status.selected {
            background: #fff3e0;
            color: #e65100;
        }

        .student-status.completed {
            background: #e3f2fd;
            color: #1565c0;
        }

        .student-status.can-retry {
            background: #fce4ec;
            color: #c2185b;
        }

        /* Report item */
        .report-item {
            background: #fff8e1;
            border: 1px solid #ffca28;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .report-item .report-info {
            margin-bottom: 10px;
        }

        .report-item .report-actions {
            display: flex;
            gap: 10px;
        }

        .report-item .report-actions button {
            padding: 5px 15px;
            font-size: 0.85em;
        }

        /* ========== H·ªÜ TH·ªêNG TH√îNG B√ÅO ƒê·∫∏P ========== */
        /* Alert Modal */
        .alert-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .alert-modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert-modal-header {
            padding: 20px 24px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .alert-modal-icon.success { background: #d4edda; }
        .alert-modal-icon.error { background: #f8d7da; }
        .alert-modal-icon.warning { background: #fff3cd; }
        .alert-modal-icon.info { background: #cce5ff; }

        .alert-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .alert-modal-body {
            padding: 16px 24px;
            color: #555;
            font-size: 15px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .alert-modal-footer {
            padding: 16px 24px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .alert-modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .alert-modal-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .alert-modal-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .alert-modal-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .alert-modal-btn.secondary:hover {
            background: #e0e0e0;
        }

        /* Toast notification ƒë·∫πp h∆°n */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 450px;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }

        .toast-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .toast.success .toast-icon { background: #d4edda; }
        .toast.error .toast-icon { background: #f8d7da; }
        .toast.warning .toast-icon { background: #fff3cd; }
        .toast.info .toast-icon { background: #cce5ff; }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .toast-message {
            color: #666;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 4px;
            font-size: 18px;
            line-height: 1;
        }

        .toast-close:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì Qu·∫£n l√Ω Tr·∫Øc nghi·ªám</h1>
            <div class="header-info">
                <span>T·ªïng c√¢u h·ªèi: <strong id="totalQuestions">0</strong></span>
                <span>H·ªçc sinh ƒë√£ n·ªôp: <strong id="totalSubmitted">0</strong></span>
                <span id="examStatus" class="status-badge status-closed">Ch∆∞a m·ªü thi</span>
            </div>
        </header>

        <!-- Toast Container -->
        <div id="toastContainer" class="toast-container"></div>

        <!-- ========== SESSION HI·ªÜN T·∫†I: L·ªöP + B√ÄI KI·ªÇM TRA ========== -->
        <div class="settings-card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                
                <!-- L·ªõp hi·ªán t·∫°i -->
                <div style="background: rgba(255,255,255,0.15); padding: 15px 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                            <span style="font-size: 1.8em;">üè´</span>
                        </div>
                        <div>
                            <p style="margin: 0; opacity: 0.85; font-size: 0.8em; text-transform: uppercase;">L·ªõp ƒëang d·∫°y</p>
                            <h3 id="currentClassName" style="margin: 3px 0 0 0; font-size: 1.2em;">Ch∆∞a ch·ªçn l·ªõp</h3>
                            <p id="currentClassInfo" style="margin: 2px 0 0 0; opacity: 0.75; font-size: 0.8em;">0 h·ªçc sinh</p>
                        </div>
                    </div>
                    <button class="btn" onclick="showClassManager()" style="background: white; color: #667eea; font-weight: bold; padding: 10px 15px; font-size: 0.9em; white-space: nowrap;">
                        üìã Qu·∫£n l√Ω L·ªõp
                    </button>
                </div>
                
                <!-- B√†i ki·ªÉm tra hi·ªán t·∫°i -->
                <div style="background: rgba(255,255,255,0.15); padding: 15px 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                            <span style="font-size: 1.8em;">üìù</span>
                        </div>
                        <div>
                            <p style="margin: 0; opacity: 0.85; font-size: 0.8em; text-transform: uppercase;">B√†i ki·ªÉm tra</p>
                            <h3 id="currentExamName" style="margin: 3px 0 0 0; font-size: 1.2em;">Ch∆∞a ch·ªçn b√†i</h3>
                            <p id="currentExamInfo" style="margin: 2px 0 0 0; opacity: 0.75; font-size: 0.8em;">0 c√¢u h·ªèi</p>
                        </div>
                    </div>
                    <button class="btn" onclick="showExamManager()" style="background: white; color: #667eea; font-weight: bold; padding: 10px 15px; font-size: 0.9em; white-space: nowrap;">
                        üìö Qu·∫£n l√Ω ƒê·ªÅ
                    </button>
                </div>
            </div>
            
            <!-- Th√¥ng tin k·∫øt qu·∫£ session hi·ªán t·∫°i -->
            <div id="sessionResultInfo" style="margin-top: 15px; background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 25px;">
                <span>üìä K·∫øt qu·∫£: <strong id="sessionResultCount">0</strong> b√†i ƒë√£ n·ªôp</span>
                <span>‚è≥ ƒêang l√†m: <strong id="sessionInProgressCount">0</strong></span>
                <span>‚úÖ Ho√†n th√†nh: <strong id="sessionCompletedCount">0</strong></span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('questions')">üìù C√¢u h·ªèi</button>
            <button class="tab" onclick="showTab('students')">üë®‚Äçüéì H·ªçc sinh</button>
            <button class="tab" onclick="showTab('results')">üìä K·∫øt qu·∫£</button>
            <button class="tab" onclick="showTab('settings')">‚öôÔ∏è C√†i ƒë·∫∑t</button>
        </div>

        <!-- ========== MODAL QU·∫¢N L√ù L·ªöP ========== -->
        <div id="classManagerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 20px; padding: 0; max-width: 700px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                
                <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 1.3em;">üè´ Qu·∫£n l√Ω L·ªõp h·ªçc</h2>
                    <button onclick="hideClassManager()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.2em; cursor: pointer; padding: 8px 12px; border-radius: 8px;">‚úï</button>
                </div>
                
                <div style="padding: 25px; max-height: calc(90vh - 80px); overflow-y: auto;">
                    
                    <!-- H∆∞·ªõng d·∫´n -->
                    <div style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #1565c0; font-size: 0.95em;">
                            üí° <strong>C√°ch d√πng:</strong> T·∫°o l·ªõp ‚Üí Upload danh s√°ch h·ªçc sinh (üì§ DS) ‚Üí Ch·ªçn l·ªõp ƒë·ªÉ d·∫°y
                        </p>
                    </div>
                    
                    <!-- T·∫°o l·ªõp m·ªõi -->
                    <div style="background: #f5f5f5; border-radius: 12px; padding: 20px; border: 2px solid #e0e0e0; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 1.5em;">‚ûï</span>
                            <h4 style="margin: 0; color: #333;">T·∫°o l·ªõp m·ªõi</h4>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newClassName" placeholder="VD: 10A1, L·ªõp Tin h·ªçc K11..." style="flex: 1; padding: 12px; border: 1px solid #bdbdbd; border-radius: 8px;">
                            <button class="btn" onclick="createNewClass()" style="background: #1976D2; color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; white-space: nowrap;">
                                ‚ûï T·∫°o l·ªõp
                            </button>
                        </div>
                    </div>
                    
                    <!-- Danh s√°ch l·ªõp -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2em;">üìã</span> Danh s√°ch l·ªõp ƒë√£ t·∫°o
                            </h4>
                            <span id="classCount" style="background: #1976D2; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">0 l·ªõp</span>
                        </div>
                        <div id="classesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 10px;">
                            <p style="color: #666; text-align: center; padding: 30px;">ƒêang t·∫£i...</p>
                        </div>
                    </div>
                    
                    <!-- T·∫£i m·∫´u Excel -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed #e0e0e0;">
                        <p style="margin: 0 0 10px 0; color: #666; font-size: 0.9em;">üì• <strong>T·∫£i m·∫´u Excel danh s√°ch h·ªçc sinh:</strong></p>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="downloadSampleExcel(1)" style="background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                üìÑ M·∫´u ƒë·∫ßy ƒë·ªß (STT, HO, TEN, NU)
                            </button>
                            <button onclick="downloadSampleExcel(2)" style="background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                üìÑ M·∫´u ph·ªï bi·∫øn (STT, TEN, NU)
                            </button>
                            <button onclick="downloadSampleExcel(3)" style="background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                üìÑ M·∫´u ƒë∆°n gi·∫£n (STT, TEN)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== MODAL QU·∫¢N L√ù B√ÄI KI·ªÇM TRA ========== -->
        <div id="examManagerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 20px; padding: 0; max-width: 700px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 1.3em;">üìù Qu·∫£n l√Ω B√†i ki·ªÉm tra</h2>
                    <button onclick="hideExamManager()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.2em; cursor: pointer; padding: 8px 12px; border-radius: 8px;">‚úï</button>
                </div>
                
                <div style="padding: 25px; max-height: calc(90vh - 80px); overflow-y: auto;">
                    
                    <!-- H∆∞·ªõng d·∫´n -->
                    <div style="background: #f0f7ff; border: 1px solid #b3d4ff; border-radius: 10px; padding: 15px; margin-bottom: 25px;">
                        <p style="margin: 0; color: #0066cc; font-size: 0.95em;">
                            üí° <strong>M·∫πo:</strong> C√πng m·ªôt b√†i ki·ªÉm tra c√≥ th·ªÉ d√πng cho nhi·ªÅu l·ªõp. M·ªói l·ªõp c√≥ k·∫øt qu·∫£ ri√™ng!
                        </p>
                    </div>
                    
                    <!-- T·∫°o b√†i m·ªõi t·ª´ file -->
                    <div style="background: #e8f5e9; border-radius: 12px; padding: 20px; border: 2px solid #81c784; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 1.5em;">üìÑ</span>
                            <h4 style="margin: 0; color: #2e7d32;">T·∫°o b√†i m·ªõi t·ª´ file</h4>
                        </div>
                        <input type="text" id="newExamName" maxlength="40" placeholder="T√™n b√†i ki·ªÉm tra (t·ªëi ƒëa 40 k√Ω t·ª±)" style="width: 100%; padding: 12px; border: 1px solid #a5d6a7; border-radius: 8px; margin-bottom: 12px; box-sizing: border-box;">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <button class="btn" onclick="createNewExam()" style="background: #4caf50; color: white; padding: 12px; border-radius: 8px; font-weight: bold;">
                                ‚ú® T·∫°o b√†i tr·ªëng
                            </button>
                            <label class="btn" style="background: #2196F3; color: white; padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; cursor: pointer;">
                                üìù Upload Word
                                <input type="file" accept=".docx" style="display: none;" onchange="createExamFromFile(this, 'word')">
                            </label>
                            <label class="btn" style="background: #ff9800; color: white; padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; cursor: pointer;">
                                üìã Upload JSON
                                <input type="file" accept=".json" style="display: none;" onchange="createExamFromFile(this, 'json')">
                            </label>
                        </div>
                        
                        <div style="margin-top: 12px; display: flex; gap: 10px; justify-content: center;">
                            <a href="/data/mau-cau-hoi.docx" download style="color: #666; font-size: 0.85em; text-decoration: underline;">üì• T·∫£i m·∫´u Word</a>
                            <a href="/data/mau-cau-hoi.json" download style="color: #666; font-size: 0.85em; text-decoration: underline;">üì• T·∫£i m·∫´u JSON</a>
                        </div>
                    </div>
                    
                    <!-- L∆∞u b√†i hi·ªán t·∫°i -->
                    <div style="background: #fff8e1; border-radius: 12px; padding: 20px; border: 2px solid #ffcc02; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 1.5em;">üíæ</span>
                            <h4 style="margin: 0; color: #f57f17;">L∆∞u b√†i ƒëang l√†m</h4>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="saveExamName" maxlength="40" placeholder="Nh·∫≠p t√™n ƒë·ªÉ l∆∞u (t·ªëi ƒëa 40 k√Ω t·ª±)" style="flex: 1; padding: 12px; border: 1px solid #ffe082; border-radius: 8px; box-sizing: border-box;">
                            <button class="btn" onclick="saveCurrentExam()" style="background: #ff9800; color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; white-space: nowrap;">
                                üíæ L∆∞u
                            </button>
                        </div>
                    </div>
                    
                    <!-- Danh s√°ch b√†i ƒë√£ l∆∞u -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2em;">üìö</span> B√†i ki·ªÉm tra ƒë√£ l∆∞u
                            </h4>
                            <span id="examCount" style="background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">0 b√†i</span>
                        </div>
                        <div id="savedExamsList" style="max-height: 350px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 10px;">
                            <p style="color: #666; text-align: center; padding: 30px;">ƒêang t·∫£i...</p>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- Panel C√¢u h·ªèi -->
        <div id="questions" class="panel active">
            
            <!-- Banner h∆∞·ªõng d·∫´n -->
            <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border: 1px solid #667eea40; border-radius: 12px; padding: 15px 20px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 5px 0; color: #667eea;">üìù ƒêang so·∫°n: <span id="currentExamNameInQuestions" style="color: #333;">--</span></h4>
                <p style="margin: 0; color: #666; font-size: 0.9em;">C√°c c√¢u h·ªèi b√™n d∆∞·ªõi s·∫Ω ƒë∆∞·ª£c th√™m v√†o b√†i ki·ªÉm tra ƒëang ch·ªçn</p>
            </div>
            
            <h2>Th√™m c√¢u h·ªèi m·ªõi</h2>
            
            <h3>‚úèÔ∏è Th√™m c√¢u h·ªèi th·ªß c√¥ng</h3>
            <form id="questionForm">
                <div class="form-group">
                    <label>N·ªôi dung c√¢u h·ªèi:</label>
                    <textarea id="questionText" placeholder="Nh·∫≠p n·ªôi dung c√¢u h·ªèi..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label>C√°c ƒë√°p √°n (ch·ªçn ƒë√°p √°n ƒë√∫ng):</label>
                    <div class="options-grid">
                        <div class="option-input">
                            <input type="radio" name="correct" value="0" checked>
                            <span class="option-label">A</span>
                            <input type="text" id="optionA" placeholder="ƒê√°p √°n A" required>
                        </div>
                        <div class="option-input">
                            <input type="radio" name="correct" value="1">
                            <span class="option-label">B</span>
                            <input type="text" id="optionB" placeholder="ƒê√°p √°n B" required>
                        </div>
                        <div class="option-input">
                            <input type="radio" name="correct" value="2">
                            <span class="option-label">C</span>
                            <input type="text" id="optionC" placeholder="ƒê√°p √°n C" required>
                        </div>
                        <div class="option-input">
                            <input type="radio" name="correct" value="3">
                            <span class="option-label">D</span>
                            <input type="text" id="optionD" placeholder="ƒê√°p √°n D" required>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">‚ûï Th√™m c√¢u h·ªèi</button>
            </form>

            <div class="question-list">
                <h2 style="margin-top: 40px; margin-bottom: 20px;">Danh s√°ch c√¢u h·ªèi</h2>
                <div id="questionsList"></div>
            </div>
        </div>

        <!-- Panel H·ªçc sinh -->
        <div id="students" class="panel">
            <h2>üë®‚Äçüéì Qu·∫£n l√Ω H·ªçc sinh</h2>
            
            <!-- B√°o c√°o ch·ªçn nh·∫ßm -->
            <div class="settings-card" id="reportsSection" style="display: none;">
                <h3>‚ö†Ô∏è B√°o c√°o ch·ªçn nh·∫ßm (<span id="reportCount">0</span>)</h3>
                <div id="reportsList"></div>
            </div>
            
            <!-- Th·ªëng k√™ h·ªçc sinh -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="statTotalStudents">0</h3>
                    <p>T·ªïng h·ªçc sinh</p>
                </div>
                <div class="stat-card">
                    <h3 id="statSelectedStudents">0</h3>
                    <p>ƒêang l√†m b√†i</p>
                </div>
                <div class="stat-card">
                    <h3 id="statCompletedStudents">0</h3>
                    <p>ƒê√£ ho√†n th√†nh</p>
                </div>
                <div class="stat-card">
                    <h3 id="statRemainingStudents">0</h3>
                    <p>Ch∆∞a l√†m</p>
                </div>
            </div>
            
            <!-- Th√¥ng b√°o h∆∞·ªõng d·∫´n -->
            <div class="settings-card" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #1976D2; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 5px 0; color: #1565C0;">üìã Danh s√°ch h·ªçc sinh c·ªßa l·ªõp: <span id="currentClassNameInStudents" style="color: #333;">--</span></h4>
                        <p style="margin: 0; color: #666; font-size: 0.9em;">ƒê·ªÉ upload ho·∫∑c thay ƒë·ªïi danh s√°ch h·ªçc sinh, vui l√≤ng v√†o qu·∫£n l√Ω L·ªõp</p>
                    </div>
                    <button class="btn btn-primary" onclick="showClassManager()" style="white-space: nowrap;">
                        üè´ Qu·∫£n l√Ω L·ªõp
                    </button>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-danger" onclick="resetAllStudents()">üîÑ Reset t·∫•t c·∫£ tr·∫°ng th√°i</button>
                <button class="btn btn-secondary" onclick="loadStudents()">üîÑ L√†m m·ªõi</button>
            </div>
            
            <table class="results-table" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>H·ªç v√† T√™n</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="studentsBody"></tbody>
            </table>
        </div>

        <!-- Panel K·∫øt qu·∫£ -->
        <div id="results" class="panel">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="statSubmitted">0</h3>
                    <p>ƒê√£ n·ªôp b√†i</p>
                </div>
                <div class="stat-card">
                    <h3 id="statAverage">0</h3>
                    <p>ƒêi·ªÉm trung b√¨nh</p>
                </div>
                <div class="stat-card">
                    <h3 id="statHighest">0</h3>
                    <p>ƒêi·ªÉm cao nh·∫•t</p>
                </div>
                <div class="stat-card">
                    <h3 id="statLowest">0</h3>
                    <p>ƒêi·ªÉm th·∫•p nh·∫•t</p>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="exportResults()">üì• Xu·∫•t Excel</button>
                <button class="btn btn-danger" onclick="clearResults()">üóëÔ∏è X√≥a t·∫•t c·∫£ k·∫øt qu·∫£</button>
                <button class="btn btn-secondary" onclick="loadResults()">üîÑ L√†m m·ªõi</button>
            </div>

            <table class="results-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>H·ªç t√™n</th>
                        <th>L·ªõp</th>
                        <th>STT l·ªõp</th>
                        <th>ƒêi·ªÉm</th>
                        <th>S·ªë c√¢u ƒë√∫ng</th>
                        <th>Th·ªùi gian l√†m</th>
                        <th>N·ªôp l√∫c</th>
                        <th>Chi ti·∫øt</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>

        <!-- Panel C√†i ƒë·∫∑t -->
        <div id="settings" class="panel">
            <div class="settings-card">
                <h3>‚öôÔ∏è C√†i ƒë·∫∑t b√†i thi</h3>
                
                <div class="form-group">
                    <label>Ti√™u ƒë·ªÅ b√†i thi:</label>
                    <input type="text" id="examTitle" value="B√†i ki·ªÉm tra tr·∫Øc nghi·ªám">
                </div>
                
                <div class="form-group">
                    <label>Th·ªùi gian l√†m b√†i (ph√∫t):</label>
                    <input type="number" id="examTime" value="30" min="1" max="180">
                </div>
                
                <div class="setting-row">
                    <div>
                        <strong>M·ªü b√†i thi</strong>
                        <p style="color: #666; font-size: 0.9em;">Cho ph√©p h·ªçc sinh b·∫Øt ƒë·∫ßu l√†m b√†i</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="examOpen" onchange="toggleExam()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <div>
                        <strong>Hi·ªÉn th·ªã ƒëi·ªÉm</strong>
                        <p style="color: #666; font-size: 0.9em;">Cho h·ªçc sinh xem ƒëi·ªÉm sau khi n·ªôp b√†i</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showScore" checked onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-row" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 15px;">
                    <div>
                        <strong style="color: #e65100;">üìö Ch·∫ø ƒë·ªô √îN T·∫¨P</strong>
                        <p style="color: #bf360c; font-size: 0.9em;">Hi·ªÉn th·ªã ƒë√∫ng/sai ngay khi h·ªçc sinh ch·ªçn ƒë√°p √°n (kh√¥ng t√≠nh ƒëi·ªÉm)</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="practiceMode" onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-row" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #1976d2; border-radius: 12px; padding: 15px; margin-top: 15px;">
                    <div style="flex: 1;">
                        <strong style="color: #0d47a1;">üîê M·∫≠t kh·∫©u b·∫Øt ƒë·∫ßu l√†m b√†i</strong>
                        <p style="color: #1565c0; font-size: 0.9em;">H·ªçc sinh ph·∫£i nh·∫≠p m·∫≠t kh·∫©u m·ªõi ƒë∆∞·ª£c l√†m b√†i (ƒë·ªÉ t·∫•t c·∫£ b·∫Øt ƒë·∫ßu c√πng l√∫c)</p>
                        <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                            <input type="text" id="examPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." style="flex: 1; padding: 10px 15px; border: 2px solid #90caf9; border-radius: 8px; font-size: 1em;" onchange="saveSettings()">
                            <button onclick="generateRandomPassword()" style="padding: 10px 15px; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;" title="T·∫°o m·∫≠t kh·∫©u ng·∫´u nhi√™n">üé≤</button>
                            <button onclick="copyPassword()" style="padding: 10px 15px; background: #43a047; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;" title="Sao ch√©p m·∫≠t kh·∫©u">üìã</button>
                        </div>
                    </div>
                    <label class="toggle-switch" style="margin-left: 15px;">
                        <input type="checkbox" id="requirePassword" onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <button class="btn btn-primary" onclick="saveSettings()" style="margin-top: 20px;">üíæ L∆∞u c√†i ƒë·∫∑t</button>
            </div>

            <div class="settings-card">
                <h3>üìã H∆∞·ªõng d·∫´n</h3>
                <ol style="line-height: 2; padding-left: 20px;">
                    <li>Th√™m c√¢u h·ªèi v√†o h·ªá th·ªëng</li>
                    <li>C√†i ƒë·∫∑t th·ªùi gian l√†m b√†i</li>
                    <li>B·∫≠t "M·ªü b√†i thi" ƒë·ªÉ h·ªçc sinh c√≥ th·ªÉ l√†m b√†i</li>
                    <li>G·ª≠i link cho h·ªçc sinh (xem ·ªü terminal)</li>
                    <li>Theo d√µi k·∫øt qu·∫£ real-time t·∫°i tab "K·∫øt qu·∫£"</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Modal s·ª≠a c√¢u h·ªèi -->
    <div id="editQuestionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(3px);">
        <div style="background: white; border-radius: 16px; width: 95%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">‚úèÔ∏è S·ª≠a c√¢u h·ªèi</h3>
                <button onclick="closeEditQuestionModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5em; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 25px;">
                <input type="hidden" id="editQuestionId">
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">üìù N·ªôi dung c√¢u h·ªèi:</label>
                    <textarea id="editQuestionText" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; resize: vertical; box-sizing: border-box;" placeholder="Nh·∫≠p n·ªôi dung c√¢u h·ªèi..."></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #333;">üìã C√°c ƒë√°p √°n (ch·ªçn ƒë√°p √°n ƒë√∫ng):</label>
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="editCorrect" value="0" id="editCorrect0" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">A</span>
                            <input type="text" id="editOptionA" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;" placeholder="ƒê√°p √°n A">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="editCorrect" value="1" id="editCorrect1" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">B</span>
                            <input type="text" id="editOptionB" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;" placeholder="ƒê√°p √°n B">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="editCorrect" value="2" id="editCorrect2" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">C</span>
                            <input type="text" id="editOptionC" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;" placeholder="ƒê√°p √°n C">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="editCorrect" value="3" id="editCorrect3" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">D</span>
                            <input type="text" id="editOptionD" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em;" placeholder="ƒê√°p √°n D">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                    <button onclick="closeEditQuestionModal()" style="padding: 12px 25px; background: #e0e0e0; color: #333; border: none; border-radius: 10px; font-size: 1em; cursor: pointer; font-weight: 600;">‚ùå H·ªßy</button>
                    <button onclick="saveEditQuestion()" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1em; cursor: pointer; font-weight: 600;">üíæ L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chi ti·∫øt -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Chi ti·∫øt b√†i l√†m</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ========== CUSTOM ALERT & CONFIRM ==========
        (function() {
            // T·∫°o modal container
            const modalHTML = `
                <div id="customAlertModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;justify-content:center;align-items:center;backdrop-filter:blur(3px);">
                    <div style="background:white;border-radius:16px;padding:0;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:modalPop 0.3s ease;">
                        <div id="alertHeader" style="padding:20px 24px 15px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px;">
                            <span id="alertIcon" style="font-size:28px;">‚ö†Ô∏è</span>
                            <span id="alertTitle" style="font-size:18px;font-weight:600;color:#333;">Th√¥ng b√°o</span>
                        </div>
                        <div style="padding:20px 24px;">
                            <p id="alertMessage" style="margin:0;color:#555;font-size:15px;line-height:1.6;"></p>
                        </div>
                        <div id="alertButtons" style="padding:15px 24px 20px;display:flex;gap:10px;justify-content:flex-end;"></div>
                    </div>
                </div>
                <style>
                    @keyframes modalPop { from{opacity:0;transform:scale(0.9);} to{opacity:1;transform:scale(1);} }
                </style>`;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            const modal = document.getElementById('customAlertModal');
            const icon = document.getElementById('alertIcon');
            const title = document.getElementById('alertTitle');
            const msg = document.getElementById('alertMessage');
            const btns = document.getElementById('alertButtons');
            
            // Custom alert
            window.showAlert = function(message, type = 'warning') {
                const icons = {warning:'‚ö†Ô∏è', error:'‚ùå', success:'‚úÖ', info:'‚ÑπÔ∏è'};
                const titles = {warning:'C·∫£nh b√°o', error:'L·ªói', success:'Th√†nh c√¥ng', info:'Th√¥ng b√°o'};
                const colors = {warning:'#f59e0b', error:'#ef4444', success:'#10b981', info:'#3b82f6'};
                
                icon.textContent = icons[type] || '‚ö†Ô∏è';
                title.textContent = titles[type] || 'Th√¥ng b√°o';
                title.style.color = colors[type] || '#333';
                msg.innerHTML = message;
                btns.innerHTML = '<button onclick="closeAlert()" style="padding:10px 24px;background:'+colors[type]+';color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;">OK</button>';
                modal.style.display = 'flex';
            };
            
            // Custom confirm
            window.showConfirm = function(message, onYes, onNo) {
                icon.textContent = '‚ùì';
                title.textContent = 'X√°c nh·∫≠n';
                title.style.color = '#3b82f6';
                msg.innerHTML = message;
                btns.innerHTML = `
                    <button onclick="closeAlert();(${onNo || function(){}})()" style="padding:10px 20px;background:#e5e7eb;color:#374151;border:none;border-radius:8px;cursor:pointer;font-size:14px;">H·ªßy</button>
                    <button onclick="closeAlert();(${onYes})()" style="padding:10px 20px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;">ƒê·ªìng √Ω</button>`;
                modal.style.display = 'flex';
            };
            
            window.closeAlert = function() { modal.style.display = 'none'; };
            modal.onclick = function(e) { if(e.target === modal) closeAlert(); };
            
            // Override alert
            window.alert = function(msg) { showAlert(msg, msg.includes('‚ùå') || msg.includes('L·ªói') ? 'error' : msg.includes('‚úÖ') ? 'success' : 'warning'); };
        })();
        // ========== END CUSTOM ALERT ==========
        
        const socket = io();
        let questions = [];
        let results = [];
        let students = [];
        let reports = [];
        
        // H√†m escape HTML ƒë·ªÉ hi·ªÉn th·ªã c√°c th·∫ª HTML nh∆∞ text
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Socket events
        socket.on('newResult', (result) => {
            showNotification(`üéâ ${result.studentName} ƒë√£ n·ªôp b√†i - ƒêi·ªÉm: ${result.score}`);
            loadResults();
            loadStudents();
        });

        socket.on('resultUpdated', (result) => {
            showNotification(`üîÑ ${result.studentName} ƒë√£ c·∫≠p nh·∫≠t b√†i - ƒêi·ªÉm: ${result.score}`);
            loadResults();
            loadStudents();
        });

        socket.on('questionsUpdated', (total) => {
            document.getElementById('totalQuestions').textContent = total;
            loadQuestions();
        });

        socket.on('studentStatusUpdated', (data) => {
            loadStudents();
        });

        socket.on('studentTabLeave', (data) => {
            showNotification(`‚ö†Ô∏è ${data.name} (STT ${data.stt}) r·ªùi trang l·∫ßn ${data.count}!`, 'warning');
            loadStudents(); // Refresh to show tab leave count
        });

        socket.on('newReport', (report) => {
            showNotification(`‚ö†Ô∏è C√≥ b√°o c√°o m·ªõi: ${report.wrongName} ‚Üí ${report.correctName}`);
            loadReports();
        });

        socket.on('allStudentsReset', () => {
            showNotification('üîÑ ƒê√£ reset t·∫•t c·∫£ tr·∫°ng th√°i h·ªçc sinh!');
            loadStudents();
        });

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Load questions
        async function loadQuestions() {
            const res = await fetch('/api/questions');
            questions = await res.json();
            document.getElementById('totalQuestions').textContent = questions.length;
            renderQuestions();
        }

        // Render questions
        function renderQuestions() {
            const container = document.getElementById('questionsList');
            if (questions.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">Ch∆∞a c√≥ c√¢u h·ªèi n√†o. H√£y th√™m c√¢u h·ªèi m·ªõi!</p>';
                return;
            }

            container.innerHTML = questions.map((q, i) => `
                <div class="question-item">
                    <div class="question-header">
                        <span class="question-number">C√¢u ${i + 1}</span>
                        <div class="question-actions">
                            <button class="btn btn-warning" onclick="editQuestion(${i})">‚úèÔ∏è S·ª≠a</button>
                            <button class="btn btn-danger" onclick="deleteQuestion(${i})">üóëÔ∏è X√≥a</button>
                        </div>
                    </div>
                    <div class="question-text">${escapeHtml(q.question)}</div>
                    ${q.image ? `<img src="${q.image}" style="max-width: 300px; margin-bottom: 15px; border-radius: 8px;">` : ''}
                    <div class="question-options">
                        ${q.options.map((opt, j) => `
                            <div class="question-option ${j === q.correct ? 'correct' : ''}">
                                <span class="option-label">${String.fromCharCode(65 + j)}</span>
                                ${escapeHtml(opt)}
                                ${j === q.correct ? ' ‚úì' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Add question
        document.getElementById('questionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const question = document.getElementById('questionText').value;
            const options = [
                document.getElementById('optionA').value,
                document.getElementById('optionB').value,
                document.getElementById('optionC').value,
                document.getElementById('optionD').value
            ];
            const correct = parseInt(document.querySelector('input[name="correct"]:checked').value);

            const res = await fetch('/api/questions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, options, correct })
            });

            if (res.ok) {
                showNotification('‚úÖ ƒê√£ th√™m c√¢u h·ªèi!');
                e.target.reset();
                loadQuestions();
            }
        });

        // Delete question
        async function deleteQuestion(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¢u h·ªèi n√†y?')) return;
            
            const res = await fetch(`/api/questions/${id}`, { method: 'DELETE' });
            if (res.ok) {
                showNotification('üóëÔ∏è ƒê√£ x√≥a c√¢u h·ªèi!');
                loadQuestions();
            }
        }

        // Edit question - m·ªü modal s·ª≠a
        function editQuestion(id) {
            const q = questions[id];
            if (!q) return;
            
            // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
            document.getElementById('editQuestionId').value = id;
            document.getElementById('editQuestionText').value = q.question || '';
            document.getElementById('editOptionA').value = q.options[0] || '';
            document.getElementById('editOptionB').value = q.options[1] || '';
            document.getElementById('editOptionC').value = q.options[2] || '';
            document.getElementById('editOptionD').value = q.options[3] || '';
            
            // Ch·ªçn ƒë√°p √°n ƒë√∫ng
            const correctRadio = document.getElementById('editCorrect' + q.correct);
            if (correctRadio) correctRadio.checked = true;
            
            // Hi·ªán modal
            document.getElementById('editQuestionModal').style.display = 'flex';
        }
        
        function closeEditQuestionModal() {
            document.getElementById('editQuestionModal').style.display = 'none';
        }
        
        async function saveEditQuestion() {
            const id = document.getElementById('editQuestionId').value;
            const question = document.getElementById('editQuestionText').value.trim();
            const optionA = document.getElementById('editOptionA').value.trim();
            const optionB = document.getElementById('editOptionB').value.trim();
            const optionC = document.getElementById('editOptionC').value.trim();
            const optionD = document.getElementById('editOptionD').value.trim();
            const correct = parseInt(document.querySelector('input[name="editCorrect"]:checked')?.value || '0');
            
            // Validate
            if (!question) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p n·ªôi dung c√¢u h·ªèi!');
                return;
            }
            if (!optionA || !optionB) {
                alert('‚ö†Ô∏è C·∫ßn √≠t nh·∫•t 2 ƒë√°p √°n!');
                return;
            }
            
            // T·∫°o m·∫£ng options (b·ªè qua ƒë√°p √°n tr·ªëng)
            const options = [optionA, optionB];
            if (optionC) options.push(optionC);
            if (optionD) options.push(optionD);
            
            // Ki·ªÉm tra correct c√≥ h·ª£p l·ªá kh√¥ng
            const validCorrect = Math.min(correct, options.length - 1);
            
            const updatedQuestion = {
                question,
                options,
                correct: validCorrect
            };
            
            try {
                const res = await fetch(`/api/questions/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedQuestion)
                });
                
                if (res.ok) {
                    showNotification('‚úÖ ƒê√£ c·∫≠p nh·∫≠t c√¢u h·ªèi!');
                    closeEditQuestionModal();
                    loadQuestions();
                } else {
                    alert('‚ùå L·ªói khi l∆∞u c√¢u h·ªèi!');
                }
            } catch (err) {
                alert('‚ùå L·ªói: ' + err.message);
            }
        }

        // Load results
        async function loadResults() {
            const res = await fetch('/api/results');
            results = await res.json();
            document.getElementById('totalSubmitted').textContent = results.length;
            renderResults();
            updateStats();
        }

        // Render results
        function renderResults() {
            const tbody = document.getElementById('resultsBody');
            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Ch∆∞a c√≥ h·ªçc sinh n√†o n·ªôp b√†i</td></tr>';
                return;
            }

            tbody.innerHTML = results.map((r, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${escapeHtml(r.studentName)}</td>
                    <td>${escapeHtml(r.studentClass || '-')}</td>
                    <td>${r.studentSTT || r.studentId || '-'}</td>
                    <td class="${r.score >= 8 ? 'score-high' : r.score >= 5 ? 'score-medium' : 'score-low'}">${r.score}</td>
                    <td>${r.correctCount}/${r.totalQuestions}</td>
                    <td>${r.timeSpent || '-'}</td>
                    <td>${r.submittedAt}</td>
                    <td><button class="btn btn-secondary" onclick="showDetail(${i})">üëÅÔ∏è Xem</button></td>
                </tr>
            `).join('');
        }

        // Update stats
        function updateStats() {
            document.getElementById('statSubmitted').textContent = results.length;
            
            if (results.length > 0) {
                const scores = results.map(r => r.score);
                const avg = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
                const highest = Math.max(...scores);
                const lowest = Math.min(...scores);
                
                document.getElementById('statAverage').textContent = avg;
                document.getElementById('statHighest').textContent = highest;
                document.getElementById('statLowest').textContent = lowest;
            }
        }

        // Show detail modal
        function showDetail(index) {
            const r = results[index];
            const content = document.getElementById('detailContent');
            
            content.innerHTML = `
                <p><strong>H·ªç t√™n:</strong> ${escapeHtml(r.studentName)}</p>
                <p><strong>L·ªõp:</strong> ${escapeHtml(r.studentClass || '-')}</p>
                <p><strong>STT:</strong> ${r.studentSTT || r.studentId || '-'}</p>
                <p><strong>ƒêi·ªÉm:</strong> ${r.score} (${r.correctCount}/${r.totalQuestions} c√¢u ƒë√∫ng)</p>
                <hr style="margin: 15px 0;">
                <h4>Chi ti·∫øt t·ª´ng c√¢u:</h4>
                ${r.details.map((d, i) => `
                    <div class="detail-item ${d.isCorrect ? 'detail-correct' : 'detail-wrong'}">
                        <strong>C√¢u ${i + 1}:</strong> ${escapeHtml(d.question)}<br>
                        <span>Tr·∫£ l·ªùi: ${d.studentAnswer !== undefined ? String.fromCharCode(65 + d.studentAnswer) : 'Kh√¥ng tr·∫£ l·ªùi'}</span>
                        ${!d.isCorrect ? ` | <span style="color: green;">ƒê√°p √°n ƒë√∫ng: ${String.fromCharCode(65 + d.correctAnswer)}</span>` : ''}
                    </div>
                `).join('')}
            `;
            
            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // Export results
        function exportResults() {
            window.location.href = '/api/results/export';
        }

        // Download sample Excel template
        function downloadSampleExcel(type) {
            if (type === 1) {
                window.location.href = '/api/sample-excel';
            } else if (type === 2) {
                window.location.href = '/api/sample-excel-2';
            } else if (type === 3) {
                window.location.href = '/api/sample-excel-3';
            }
        }

        // Upload danh s√°ch h·ªçc sinh
        async function uploadStudentList(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Ki·ªÉm tra ƒë·ªãnh d·∫°ng file
            const validExtensions = ['.xlsx', '.xls'];
            const fileName = file.name.toLowerCase();
            const isValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!isValidExtension) {
                showNotification('‚ùå Ch·ªâ ch·∫•p nh·∫≠n file Excel (.xlsx ho·∫∑c .xls)!', 'error');
                input.value = '';
                return;
            }
            
            showNotification('‚è≥ ƒêang t·∫£i l√™n...', 'info');
            
            try {
                const res = await fetch('/api/upload-students', {
                    method: 'POST',
                    body: file,
                    headers: {
                        'Content-Type': 'application/octet-stream'
                    }
                });
                
                const result = await res.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    loadStudents();
                    
                    // Hi·ªán c·∫£nh b√°o n·∫øu c√≥
                    if (result.warnings && result.warnings.length > 0) {
                        setTimeout(() => {
                            alert('‚ö†Ô∏è M·ªôt s·ªë d√≤ng c√≥ l·ªói:\n\n' + result.warnings.join('\n'));
                        }, 500);
                    }
                } else {
                    let errorMsg = result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
                    if (result.details && result.details.length > 0) {
                        errorMsg += '\n\nChi ti·∫øt:\n' + result.details.slice(0, 5).join('\n');
                        if (result.details.length > 5) {
                            errorMsg += `\n... v√† ${result.details.length - 5} l·ªói kh√°c`;
                        }
                    }
                    showNotification('‚ùå ' + result.error, 'error');
                    alert('‚ùå L·ªói ƒë·ªãnh d·∫°ng file!\n\n' + errorMsg);
                }
            } catch (err) {
                console.error('L·ªói upload:', err);
                showNotification('‚ùå L·ªói k·∫øt n·ªëi server!', 'error');
            }
            
            // Reset input ƒë·ªÉ c√≥ th·ªÉ upload l·∫°i c√πng file
            input.value = '';
        }

        // Clear results
        async function clearResults() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ k·∫øt qu·∫£?')) return;
            
            const res = await fetch('/api/results', { method: 'DELETE' });
            if (res.ok) {
                showNotification('üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£ k·∫øt qu·∫£!');
                loadResults();
            }
        }

        // Settings
        async function loadSettings() {
            const res = await fetch('/api/settings');
            const settings = await res.json();
            
            document.getElementById('examTitle').value = settings.title;
            document.getElementById('examTime').value = settings.timeLimit;
            document.getElementById('examOpen').checked = settings.isOpen;
            document.getElementById('showScore').checked = settings.showScore !== false;
            document.getElementById('practiceMode').checked = settings.practiceMode === true;
            document.getElementById('examPassword').value = settings.examPassword || '';
            document.getElementById('requirePassword').checked = settings.requirePassword === true;
            updateExamStatus(settings.isOpen);
        }

        async function saveSettings() {
            const settings = {
                title: document.getElementById('examTitle').value,
                timeLimit: parseInt(document.getElementById('examTime').value),
                isOpen: document.getElementById('examOpen').checked,
                showScore: document.getElementById('showScore').checked,
                practiceMode: document.getElementById('practiceMode').checked,
                examPassword: document.getElementById('examPassword').value,
                requirePassword: document.getElementById('requirePassword').checked
            };

            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (res.ok) {
                showNotification('üíæ ƒê√£ l∆∞u c√†i ƒë·∫∑t!');
            }
        }
        
        // T·∫°o m·∫≠t kh·∫©u ng·∫´u nhi√™n
        function generateRandomPassword() {
            const chars = '0123456789ABCDEFGHJKLMNPQRSTUVWXYZ'; // B·ªè O, I ƒë·ªÉ tr√°nh nh·∫ßm
            let password = '';
            for (let i = 0; i < 6; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('examPassword').value = password;
            document.getElementById('requirePassword').checked = true;
            saveSettings();
            showNotification('üé≤ M·∫≠t kh·∫©u m·ªõi: ' + password);
        }
        
        // Sao ch√©p m·∫≠t kh·∫©u
        function copyPassword() {
            const password = document.getElementById('examPassword').value;
            if (!password) {
                showNotification('‚ö†Ô∏è Ch∆∞a c√≥ m·∫≠t kh·∫©u!', 'warning');
                return;
            }
            navigator.clipboard.writeText(password).then(() => {
                showNotification('üìã ƒê√£ sao ch√©p: ' + password);
            }).catch(() => {
                showNotification('‚ùå Kh√¥ng th·ªÉ sao ch√©p', 'error');
            });
        }

        async function toggleExam() {
            const isOpen = document.getElementById('examOpen').checked;
            updateExamStatus(isOpen);
            await saveSettings();
        }

        function updateExamStatus(isOpen) {
            const badge = document.getElementById('examStatus');
            if (isOpen) {
                badge.textContent = 'üü¢ ƒêang m·ªü thi';
                badge.className = 'status-badge status-open';
            } else {
                badge.textContent = 'üî¥ Ch∆∞a m·ªü thi';
                badge.className = 'status-badge status-closed';
            }
        }

        // Notification
        // ========== H·ªÜ TH·ªêNG TH√îNG B√ÅO ƒê·∫∏P ==========
        function showNotification(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            
            // X√°c ƒë·ªãnh lo·∫°i th√¥ng b√°o
            let icon = '‚úÖ';
            let title = 'Th√†nh c√¥ng';
            if (message.includes('‚ùå') || type === 'error') {
                type = 'error';
                icon = '‚ùå';
                title = 'L·ªói';
                message = message.replace('‚ùå ', '');
            } else if (message.includes('‚ö†Ô∏è') || type === 'warning') {
                type = 'warning';
                icon = '‚ö†Ô∏è';
                title = 'C·∫£nh b√°o';
                message = message.replace('‚ö†Ô∏è ', '');
            } else if (message.includes('‚ÑπÔ∏è') || type === 'info') {
                type = 'info';
                icon = '‚ÑπÔ∏è';
                title = 'Th√¥ng tin';
                message = message.replace('‚ÑπÔ∏è ', '');
            } else {
                message = message.replace('‚úÖ ', '');
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Alert modal ƒë·∫πp - thay th·∫ø alert() m·∫∑c ƒë·ªãnh
        function showAlert(message, type = 'warning', callback = null) {
            // X√°c ƒë·ªãnh lo·∫°i
            let icon = '‚ö†Ô∏è';
            let title = 'Th√¥ng b√°o';
            let btnClass = 'primary';
            
            if (message.includes('‚ùå') || type === 'error') {
                type = 'error';
                icon = '‚ùå';
                title = 'C√≥ l·ªói x·∫£y ra';
                message = message.replace('‚ùå ', '');
            } else if (message.includes('‚ö†Ô∏è') || type === 'warning') {
                type = 'warning';
                icon = '‚ö†Ô∏è';
                title = 'C·∫£nh b√°o';
                message = message.replace('‚ö†Ô∏è ', '');
            } else if (message.includes('‚úÖ') || type === 'success') {
                type = 'success';
                icon = '‚úÖ';
                title = 'Th√†nh c√¥ng';
                message = message.replace('‚úÖ ', '');
            } else if (type === 'info') {
                icon = '‚ÑπÔ∏è';
                title = 'Th√¥ng tin';
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'alert-modal-overlay';
            overlay.innerHTML = `
                <div class="alert-modal">
                    <div class="alert-modal-header">
                        <div class="alert-modal-icon ${type}">${icon}</div>
                        <div class="alert-modal-title">${title}</div>
                    </div>
                    <div class="alert-modal-body">${message}</div>
                    <div class="alert-modal-footer">
                        <button class="alert-modal-btn primary" onclick="this.closest('.alert-modal-overlay').remove(); ${callback ? 'window.__alertCallback && window.__alertCallback()' : ''}">OK</button>
                    </div>
                </div>
            `;
            
            if (callback) {
                window.__alertCallback = callback;
            }
            
            document.body.appendChild(overlay);
            
            // Click outside ƒë·ªÉ ƒë√≥ng
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
            
            // ESC ƒë·ªÉ ƒë√≥ng
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        // Confirm modal ƒë·∫πp - thay th·∫ø confirm() m·∫∑c ƒë·ªãnh
        function showConfirm(message, onConfirm, onCancel = null) {
            const overlay = document.createElement('div');
            overlay.className = 'alert-modal-overlay';
            overlay.innerHTML = `
                <div class="alert-modal">
                    <div class="alert-modal-header">
                        <div class="alert-modal-icon warning">‚ùì</div>
                        <div class="alert-modal-title">X√°c nh·∫≠n</div>
                    </div>
                    <div class="alert-modal-body">${message}</div>
                    <div class="alert-modal-footer">
                        <button class="alert-modal-btn secondary" id="confirmCancel">H·ªßy</button>
                        <button class="alert-modal-btn primary" id="confirmOK">ƒê·ªìng √Ω</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            overlay.querySelector('#confirmOK').onclick = () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            };
            
            overlay.querySelector('#confirmCancel').onclick = () => {
                overlay.remove();
                if (onCancel) onCancel();
            };
            
            // Click outside ƒë·ªÉ ƒë√≥ng
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                    if (onCancel) onCancel();
                }
            });
        }

        // ========== QU·∫¢N L√ù SESSION (L·ªöP + B√ÄI) ==========
        let currentSession = { classId: null, className: null, examId: null, examName: null };
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã session
        async function updateSessionDisplay() {
            try {
                const res = await fetch('/api/session');
                const data = await res.json();
                currentSession = data.currentSession;
                
                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã l·ªõp
                document.getElementById('currentClassName').textContent = currentSession.className || 'Ch∆∞a ch·ªçn l·ªõp';
                document.getElementById('currentClassInfo').textContent = data.studentCount + ' h·ªçc sinh';
                
                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã b√†i ki·ªÉm tra
                document.getElementById('currentExamName').textContent = currentSession.examName || 'Ch∆∞a ch·ªçn b√†i';
                
                // C·∫≠p nh·∫≠t s·ªë c√¢u h·ªèi t·ª´ API
                const qRes = await fetch('/api/questions');
                const qs = await qRes.json();
                document.getElementById('currentExamInfo').textContent = (qs.length || 0) + ' c√¢u h·ªèi';
                
                // C·∫≠p nh·∫≠t th·ªëng k√™
                document.getElementById('sessionResultCount').textContent = data.resultCount;
                
                // C·∫≠p nh·∫≠t c√°c banner trong c√°c tab
                const classNameInStudents = document.getElementById('currentClassNameInStudents');
                if (classNameInStudents) {
                    classNameInStudents.textContent = currentSession.className || 'Ch∆∞a ch·ªçn l·ªõp';
                }
                
                const examNameInQuestions = document.getElementById('currentExamNameInQuestions');
                if (examNameInQuestions) {
                    examNameInQuestions.textContent = currentSession.examName || 'Ch∆∞a ch·ªçn b√†i';
                }
                
            } catch (err) {
                console.error('L·ªói c·∫≠p nh·∫≠t session:', err);
            }
        }
        
        // ========== QU·∫¢N L√ù L·ªöP ==========
        function showClassManager() {
            document.getElementById('classManagerModal').style.display = 'flex';
            loadClasses();
        }
        
        function hideClassManager() {
            document.getElementById('classManagerModal').style.display = 'none';
        }
        
        async function loadClasses() {
            try {
                const res = await fetch('/api/classes');
                const data = await res.json();
                
                const listDiv = document.getElementById('classesList');
                document.getElementById('classCount').textContent = data.classes.length + ' l·ªõp';
                
                if (data.classes.length === 0) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;">üè´</div>
                            <p style="margin: 0;">Ch∆∞a c√≥ l·ªõp n√†o</p>
                            <p style="margin: 10px 0 0 0; font-size: 0.9em; opacity: 0.7;">T·∫°o l·ªõp m·ªõi ƒë·ªÉ qu·∫£n l√Ω h·ªçc sinh v√† k·∫øt qu·∫£</p>
                        </div>
                    `;
                    return;
                }
                
                listDiv.innerHTML = data.classes.map(cls => `
                    <div style="padding: 15px 18px; background: ${cls.id === currentSession.classId ? 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)' : 'white'}; border-bottom: 1px solid #eee; ${cls.id === currentSession.classId ? 'border-left: 4px solid #1976D2;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 1.3em;">${cls.id === currentSession.classId ? 'üìå' : 'üè´'}</span>
                                    <div>
                                        <strong style="font-size: 1.05em; color: #333;">${escapeHtml(cls.name)}</strong>
                                        ${cls.id === currentSession.classId ? '<span style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.7em; margin-left: 10px; font-weight: bold;">ƒêANG D√ôNG</span>' : ''}
                                        <div style="color: #888; font-size: 0.85em; margin-top: 3px;">
                                            üë®‚Äçüéì ${cls.studentCount || 0} h·ªçc sinh
                                            ${cls.studentFile ? '‚úÖ' : '<span style="color: #ff9800;">‚ö†Ô∏è Ch∆∞a upload danh s√°ch</span>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <!-- N√∫t upload danh s√°ch -->
                                <label style="background: #e3f2fd; color: #1565c0; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85em;" title="Upload danh s√°ch h·ªçc sinh">
                                    üì§ DS
                                    <input type="file" accept=".xlsx,.xls" style="display: none;" onchange="uploadClassStudents('${cls.id}', this)">
                                </label>
                                ${cls.id !== currentSession.classId ? `
                                    <button onclick="switchToClass('${cls.id}')" style="background: #1976D2; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                        ‚ñ∂Ô∏è Ch·ªçn
                                    </button>
                                    <button onclick="deleteClass('${cls.id}')" style="background: #ffebee; color: #c62828; border: none; padding: 10px 12px; border-radius: 8px; cursor: pointer;" title="X√≥a l·ªõp">
                                        üóëÔ∏è
                                    </button>
                                ` : `
                                    <span style="color: #1976D2; font-weight: bold; padding: 10px;">‚úì ƒêang ch·ªçn</span>
                                `}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('L·ªói t·∫£i danh s√°ch l·ªõp:', err);
            }
        }
        
        // Upload danh s√°ch h·ªçc sinh cho l·ªõp
        async function uploadClassStudents(classId, input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const res = await fetch(`/api/classes/${classId}/students`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification('‚úÖ ' + result.message);
                    loadClasses();
                    // N·∫øu l√† l·ªõp ƒëang ch·ªçn, reload students
                    if (classId === currentSession.classId) {
                        loadStudents();
                        updateSessionDisplay();
                    }
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (err) {
                alert('‚ùå L·ªói upload: ' + err.message);
            }
            
            input.value = ''; // Reset input
        }
        
        async function createNewClass() {
            const name = document.getElementById('newClassName').value.trim();
            if (!name) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n l·ªõp!');
                document.getElementById('newClassName').focus();
                return;
            }
            
            try {
                const res = await fetch('/api/classes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification('‚úÖ ' + result.message);
                    document.getElementById('newClassName').value = '';
                    loadClasses();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (err) {
                alert('‚ùå L·ªói: ' + err.message);
            }
        }
        
        async function switchToClass(classId) {
            try {
                const res = await fetch('/api/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ classId })
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification('‚úÖ ƒê√£ ch·ªçn l·ªõp: ' + result.currentSession.className);
                    hideClassManager();
                    updateSessionDisplay();
                    loadStudents();
                    loadResults();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (err) {
                alert('‚ùå L·ªói: ' + err.message);
            }
        }
        
        async function deleteClass(classId) {
            if (!confirm('üóëÔ∏è X√≥a l·ªõp n√†y?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;
            
            try {
                const res = await fetch(`/api/classes/${classId}`, { method: 'DELETE' });
                const result = await res.json();
                
                if (result.success) {
                    showNotification('üóëÔ∏è ƒê√£ x√≥a l·ªõp');
                    loadClasses();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (err) {
                alert('‚ùå L·ªói: ' + err.message);
            }
        }

        // ========== QU·∫¢N L√ù B√ÄI KI·ªÇM TRA ==========
        
        function showExamManager() {
            document.getElementById('examManagerModal').style.display = 'flex';
            loadSavedExams();
        }
        
        function hideExamManager() {
            document.getElementById('examManagerModal').style.display = 'none';
        }
        
        async function loadSavedExams() {
            try {
                const res = await fetch('/api/exams');
                const data = await res.json();
                
                const listDiv = document.getElementById('savedExamsList');
                document.getElementById('examCount').textContent = data.exams.length + ' b√†i';
                
                if (data.exams.length === 0) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;">üì≠</div>
                            <p style="margin: 0;">Ch∆∞a c√≥ b√†i ki·ªÉm tra n√†o ƒë∆∞·ª£c l∆∞u</p>
                            <p style="margin: 10px 0 0 0; font-size: 0.9em; opacity: 0.7;">L∆∞u b√†i ki·ªÉm tra ƒë·ªÉ d√πng l·∫°i cho c√°c l·ªõp kh√°c</p>
                        </div>
                    `;
                    return;
                }
                
                listDiv.innerHTML = data.exams.map(exam => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 18px; background: ${exam.id === currentSession.examId ? 'linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%)' : 'white'}; border-bottom: 1px solid #eee; ${exam.id === currentSession.examId ? 'border-left: 4px solid #667eea;' : ''}">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.3em;">${exam.id === currentSession.examId ? 'üìå' : 'üìÑ'}</span>
                                <div>
                                    <strong style="font-size: 1.05em; color: #333;">${escapeHtml(exam.name)}</strong>
                                    ${exam.id === currentSession.examId ? '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.7em; margin-left: 10px; font-weight: bold;">ƒêANG D√ôNG</span>' : ''}
                                    <div style="color: #888; font-size: 0.85em; margin-top: 3px;">üìù ${exam.questionCount} c√¢u h·ªèi</div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${exam.id !== currentSession.examId ? `
                                <button onclick="switchToExam('${exam.id}')" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.background='#5a6fd6'" onmouseout="this.style.background='#667eea'">
                                    ‚ñ∂Ô∏è S·ª≠ d·ª•ng
                                </button>
                                <button onclick="deleteExam('${exam.id}')" style="background: #ffebee; color: #c62828; border: none; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ffcdd2'" onmouseout="this.style.background='#ffebee'" title="X√≥a b√†i n√†y">
                                    üóëÔ∏è
                                </button>
                            ` : `
                                <span style="color: #667eea; font-weight: bold; padding: 10px;">‚úì ƒêang s·ª≠ d·ª•ng</span>
                            `}
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('L·ªói t·∫£i danh s√°ch b√†i ki·ªÉm tra:', err);
            }
        }
        
        async function createNewExam() {
            const name = document.getElementById('newExamName').value.trim();
            if (!name) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n b√†i ki·ªÉm tra!');
                document.getElementById('newExamName').focus();
                return;
            }
            
            if (!confirm(`‚ú® T·∫°o b√†i ki·ªÉm tra m·ªõi: "${name}"\n\nB√†i m·ªõi s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o danh s√°ch.\nB√†i ƒëang d√πng KH√îNG thay ƒë·ªïi.\nTi·∫øp t·ª•c?`)) return;
            
            try {
                const res = await fetch('/api/exams/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification(`‚úÖ ƒê√£ t·∫°o b√†i "${name}" (ch∆∞a s·ª≠ d·ª•ng)`);
                    document.getElementById('newExamName').value = '';
                    loadSavedExams(); // Ch·ªâ load l·∫°i danh s√°ch b√†i
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (err) {
                alert('‚ùå L·ªói: ' + err.message);
            }
        }
        
        async function saveCurrentExam() {
            let name = document.getElementById('saveExamName').value.trim();
            if (!name) {
                name = document.getElementById('currentExamName').textContent;
                if (!name || name === 'Ch∆∞a ch·ªçn b√†i') {
                    alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n ƒë·ªÉ l∆∞u!');
                    document.getElementById('saveExamName').focus();
                    return;
                }
            }
            
            try {
                const res = await fetch('/api/exams/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification('üíæ ƒê√£ l∆∞u: ' + name);
                    document.getElementById('saveExamName').value = '';
                    loadSavedExams();
                    updateSessionDisplay();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (err) {
                alert('‚ùå L·ªói: ' + err.message);
            }
        }
        
        async function switchToExam(examId) {
            // Kh√¥ng c·∫ßn reset v√¨ m·ªói l·ªõp+b√†i c√≥ k·∫øt qu·∫£ ri√™ng
            try {
                const res = await fetch('/api/exams/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ examId, resetStudents: false })
                });
                
                const result = await res.json();
                if (result.success) {
                    showNotification('‚úÖ ƒê√£ chuy·ªÉn sang: ' + result.examName);
                    hideExamManager();
                    loadQuestions();
                    loadResults();
                    loadStudents();
                    loadSettings();
                    updateSessionDisplay();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (err) {
                alert('‚ùå L·ªói: ' + err.message);
            }
        }
        
        async function deleteExam(examId) {
            if (!confirm('üóëÔ∏è X√≥a b√†i ki·ªÉm tra n√†y?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;
            
            try {
                const res = await fetch(`/api/exams/${examId}`, { method: 'DELETE' });
                const result = await res.json();
                
                if (result.success) {
                    showNotification('üóëÔ∏è ƒê√£ x√≥a b√†i ki·ªÉm tra');
                    loadSavedExams();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (err) {
                alert('‚ùå L·ªói: ' + err.message);
            }
        }
        
        // T·∫°o b√†i ki·ªÉm tra m·ªõi t·ª´ file Word ho·∫∑c JSON (KH√îNG chuy·ªÉn sang d√πng)
        async function createExamFromFile(input, fileType) {
            const file = input.files[0];
            if (!file) return;
            
            const examName = document.getElementById('newExamName').value.trim();
            if (!examName) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n b√†i ki·ªÉm tra tr∆∞·ªõc khi upload!');
                document.getElementById('newExamName').focus();
                input.value = '';
                return;
            }
            
            try {
                // B∆∞·ªõc 1: T·∫°o b√†i ki·ªÉm tra m·ªõi (KH√îNG chuy·ªÉn sang d√πng)
                const createRes = await fetch('/api/exams/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: examName })
                });
                
                const createResult = await createRes.json();
                if (!createResult.success) {
                    alert('‚ùå ' + createResult.error);
                    input.value = '';
                    return;
                }
                
                const newExamId = createResult.examId;
                
                // B∆∞·ªõc 2: Import c√¢u h·ªèi v√†o b√†i v·ª´a t·∫°o (kh√¥ng ·∫£nh h∆∞·ªüng b√†i ƒëang d√πng)
                const formData = new FormData();
                formData.append('file', file);
                
                const uploadUrl = fileType === 'json' 
                    ? `/api/exams/${newExamId}/import-json` 
                    : `/api/exams/${newExamId}/import-word`;
                
                const uploadRes = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData
                });
                
                const uploadResult = await uploadRes.json();
                if (uploadResult.success) {
                    const count = uploadResult.count || 0;
                    showNotification(`‚úÖ ƒê√£ t·∫°o "${examName}" v·ªõi ${count} c√¢u h·ªèi (ch∆∞a s·ª≠ d·ª•ng)`);
                } else {
                    showNotification('‚ö†Ô∏è ƒê√£ t·∫°o b√†i nh∆∞ng import l·ªói: ' + uploadResult.error);
                }
                
                // C·∫≠p nh·∫≠t danh s√°ch b√†i - KH√îNG thay ƒë·ªïi b√†i ƒëang d√πng
                document.getElementById('newExamName').value = '';
                loadSavedExams(); // Ch·ªâ load l·∫°i danh s√°ch b√†i ƒë√£ l∆∞u
                
            } catch (err) {
                alert('‚ùå L·ªói: ' + err.message);
            }
            
            input.value = '';
        }
        
        function updateCurrentExamDisplay() {
            fetch('/api/questions')
                .then(res => res.json())
                .then(qs => {
                    document.getElementById('currentExamInfo').textContent = qs.length + ' c√¢u h·ªèi';
                });
            // C·∫≠p nh·∫≠t th·ªëng k√™ session
            updateStudentStats();
        }
        
        // Listen for exam switch events
        socket.on('examSwitched', (data) => {
            showNotification(`üìö ƒê√£ chuy·ªÉn sang: ${data.examName}`);
            loadQuestions();
            loadResults();
            loadSettings();
            updateSessionDisplay();
        });
        
        // Listen for session change events
        socket.on('sessionChanged', (session) => {
            currentSession = session;
            updateSessionDisplay();
        });
        
        // ========== END QU·∫¢N L√ù B√ÄI KI·ªÇM TRA ==========

        // Initialize
        loadQuestions();
        loadResults();
        loadSettings();
        loadStudents();
        loadReports();
        updateSessionDisplay(); // Thay v√¨ updateCurrentExamDisplay

        // Load students
        async function loadStudents() {
            try {
                const res = await fetch('/api/students');
                students = await res.json();
                renderStudents();
                updateStudentStats();
            } catch (err) {
                console.error('L·ªói t·∫£i danh s√°ch h·ªçc sinh:', err);
            }
        }

        // Render students
        function renderStudents() {
            const tbody = document.getElementById('studentsBody');
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Ch∆∞a c√≥ danh s√°ch h·ªçc sinh. H√£y ƒë·∫∑t file danhsach.xlsx v√†o th∆∞ m·ª•c danhsach/</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(s => {
                let statusClass = 'available';
                let statusText = 'Ch∆∞a ch·ªçn';
                
                if (s.status.completed) {
                    statusClass = 'completed';
                    statusText = '‚úÖ ƒê√£ ho√†n th√†nh';
                } else if (s.status.canRetry) {
                    statusClass = 'can-retry';
                    statusText = 'üîÑ ƒê∆∞·ª£c l√†m l·∫°i';
                } else if (s.status.selected) {
                    statusClass = 'selected';
                    statusText = '‚è≥ ƒêang l√†m b√†i';
                }

                const actions = [];
                if (s.status.completed && !s.status.canRetry) {
                    actions.push(`<button class="btn btn-warning" onclick="allowRetry(${s.stt})">üîÑ Cho l√†m l·∫°i</button>`);
                }
                if (s.status.selected && !s.status.completed) {
                    actions.push(`<button class="btn btn-danger" onclick="forceDeselect(${s.stt})">‚ùå H·ªßy ch·ªçn</button>`);
                }
                
                // Show tab leave warning
                const tabLeaveCount = s.status.tabLeaveCount || 0;
                const tabLeaveWarning = tabLeaveCount > 0 
                    ? `<span style="color: #dc3545; font-weight: bold; margin-left: 8px;" title="R·ªùi trang ${tabLeaveCount} l·∫ßn">‚ö†Ô∏è ${tabLeaveCount}</span>` 
                    : '';

                return `
                    <tr>
                        <td>${s.stt}</td>
                        <td>${escapeHtml(s.ho)} ${escapeHtml(s.ten)} ${s.nu === 'X' ? 'üëß' : ''}</td>
                        <td><span class="student-status ${statusClass}">${statusText}</span>${tabLeaveWarning}</td>
                        <td>${actions.join(' ') || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Update student stats
        function updateStudentStats() {
            const total = students.length;
            const selected = students.filter(s => s.status.selected && !s.status.completed).length;
            const completed = students.filter(s => s.status.completed).length;
            const remaining = total - completed;

            document.getElementById('statTotalStudents').textContent = total;
            document.getElementById('statSelectedStudents').textContent = selected;
            document.getElementById('statCompletedStudents').textContent = completed;
            document.getElementById('statRemainingStudents').textContent = remaining;
            
            // C·∫≠p nh·∫≠t th·ªëng k√™ session
            document.getElementById('sessionInProgressCount').textContent = selected;
            document.getElementById('sessionCompletedCount').textContent = completed;
        }

        // Allow retry
        async function allowRetry(stt) {
            if (!confirm('Cho ph√©p h·ªçc sinh n√†y l√†m l·∫°i b√†i?')) return;

            try {
                const res = await fetch('/api/allow-retry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stt })
                });

                if (res.ok) {
                    showNotification('‚úÖ ƒê√£ cho ph√©p l√†m l·∫°i!');
                    loadStudents();
                }
            } catch (err) {
                showNotification('‚ùå L·ªói: ' + err.message);
            }
        }

        // Force deselect
        async function forceDeselect(stt) {
            if (!confirm('H·ªßy ch·ªçn c·ªßa h·ªçc sinh n√†y?')) return;

            // T√¨m socketId c·ªßa h·ªçc sinh
            const student = students.find(s => s.stt == stt);
            if (!student || !student.status.selectedBy) return;

            try {
                const res = await fetch('/api/deselect-student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stt, socketId: student.status.selectedBy })
                });

                if (res.ok) {
                    showNotification('‚úÖ ƒê√£ h·ªßy ch·ªçn!');
                    loadStudents();
                }
            } catch (err) {
                showNotification('‚ùå L·ªói: ' + err.message);
            }
        }

        // Reset all students
        async function resetAllStudents() {
            if (!confirm('‚ö†Ô∏è Reset T·∫§T C·∫¢ tr·∫°ng th√°i h·ªçc sinh?\n\nƒêi·ªÅu n√†y s·∫Ω:\n- H·ªßy t·∫•t c·∫£ l·ª±a ch·ªçn hi·ªán t·∫°i\n- Cho ph√©p t·∫•t c·∫£ h·ªçc sinh ch·ªçn l·∫°i\n- KH√îNG x√≥a k·∫øt qu·∫£ b√†i thi')) return;

            try {
                const res = await fetch('/api/reset-all-students', { method: 'POST' });

                if (res.ok) {
                    showNotification('‚úÖ ƒê√£ reset t·∫•t c·∫£!');
                    loadStudents();
                }
            } catch (err) {
                showNotification('‚ùå L·ªói: ' + err.message);
            }
        }

        // Load reports
        async function loadReports() {
            try {
                const res = await fetch('/api/reports');
                reports = await res.json();
                renderReports();
            } catch (err) {
                console.error('L·ªói t·∫£i b√°o c√°o:', err);
            }
        }

        // Render reports
        function renderReports() {
            const section = document.getElementById('reportsSection');
            const container = document.getElementById('reportsList');
            const countEl = document.getElementById('reportCount');

            countEl.textContent = reports.length;

            if (reports.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = reports.map(r => `
                <div class="report-item">
                    <div class="report-info">
                        <strong>B√°o c√°o l√∫c:</strong> ${r.createdAt}<br>
                        <strong>ƒê√£ ch·ªçn nh·∫ßm:</strong> ${escapeHtml(r.wrongName)} (STT ${r.wrongSTT})<br>
                        <strong>T√™n ƒë√∫ng:</strong> ${escapeHtml(r.correctName)} (STT ${r.correctSTT})<br>
                        ${r.reason ? `<strong>L√Ω do:</strong> ${escapeHtml(r.reason)}` : ''}
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-success" onclick="approveReport(${r.id})">‚úÖ Duy·ªát</button>
                        <button class="btn btn-danger" onclick="rejectReport(${r.id})">‚ùå T·ª´ ch·ªëi</button>
                    </div>
                </div>
            `).join('');
        }

        // Approve report
        async function approveReport(reportId) {
            try {
                const res = await fetch('/api/approve-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportId })
                });

                if (res.ok) {
                    showNotification('‚úÖ ƒê√£ duy·ªát b√°o c√°o!');
                    loadReports();
                    loadStudents();
                }
            } catch (err) {
                showNotification('‚ùå L·ªói: ' + err.message);
            }
        }

        // Reject report
        async function rejectReport(reportId) {
            try {
                const res = await fetch('/api/reject-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reportId })
                });

                if (res.ok) {
                    showNotification('‚úÖ ƒê√£ t·ª´ ch·ªëi b√°o c√°o!');
                    loadReports();
                }
            } catch (err) {
                showNotification('‚ùå L·ªói: ' + err.message);
            }
        }

        // Import Word file
        async function importWord(input) {
            const file = input.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('importStatus');
            statusDiv.innerHTML = '<span style="color: #667eea;">‚è≥ ƒêang x·ª≠ l√Ω file...</span>';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const res = await fetch('/api/import-word', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await res.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `<span style="color: #28a745;">‚úÖ ƒê√£ import ${result.imported} c√¢u h·ªèi! T·ªïng: ${result.total} c√¢u</span>`;
                    loadQuestions();
                } else {
                    statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå ${result.error}</span>`;
                }
            } catch (err) {
                statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå L·ªói: ${err.message}</span>`;
            }
            
            input.value = ''; // Reset input
        }

        // Download sample JSON
        function downloadSampleJSON() {
            const sampleQuestions = [
                {
                    "question": "Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√† g√¨?",
                    "options": ["H√† N·ªôi", "H·ªì Ch√≠ Minh", "ƒê√† N·∫µng", "Hu·∫ø"],
                    "correct": 0
                },
                {
                    "question": "1 + 1 = ?",
                    "options": ["1", "2", "3", "4"],
                    "correct": 1
                },
                {
                    "question": "Th·∫ª HTML n√†o d√πng ƒë·ªÉ t·∫°o ti√™u ƒë·ªÅ l·ªõn nh·∫•t?",
                    "options": ["<h6>", "<h1>", "<header>", "<title>"],
                    "correct": 1
                }
            ];
            
            const dataStr = JSON.stringify(sampleQuestions, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mau-cau-hoi.json';
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Import JSON file
        async function importJSON(input) {
            const file = input.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('importStatus');
            statusDiv.innerHTML = '<span style="color: #667eea;">‚è≥ ƒêang x·ª≠ l√Ω file JSON...</span>';
            
            try {
                const text = await file.text();
                let jsonData;
                
                try {
                    jsonData = JSON.parse(text);
                } catch (parseErr) {
                    statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå File JSON kh√¥ng h·ª£p l·ªá. Ki·ªÉm tra c√∫ ph√°p JSON.</span>';
                    input.value = '';
                    return;
                }
                
                const res = await fetch('/api/upload-questions-json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonData)
                });
                
                const result = await res.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `<span style="color: #28a745;">‚úÖ ƒê√£ import ${result.imported} c√¢u h·ªèi! T·ªïng: ${result.total} c√¢u</span>`;
                    loadQuestions();
                    
                    if (result.warnings && result.warnings.length > 0) {
                        setTimeout(() => {
                            alert('‚ö†Ô∏è M·ªôt s·ªë c√¢u h·ªèi c√≥ l·ªói:\n\n' + result.warnings.slice(0, 5).join('\n') + 
                                  (result.warnings.length > 5 ? `\n... v√† ${result.warnings.length - 5} l·ªói kh√°c` : ''));
                        }, 500);
                    }
                } else {
                    let errorMsg = result.error;
                    if (result.details && result.details.length > 0) {
                        errorMsg += '\n\n' + result.details.slice(0, 3).join('\n');
                    }
                    statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå ${result.error}</span>`;
                    alert('‚ùå L·ªói import:\n\n' + errorMsg);
                }
            } catch (err) {
                statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå L·ªói: ${err.message}</span>`;
            }
            
            input.value = ''; // Reset input
        }
    </script>
    
    <!-- Footer Copyright -->
    <footer style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); color: #e8e8e8; padding: 25px 20px; margin-top: 40px; border-top: 3px solid #667eea;">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px;">
            <div style="flex: 1; min-width: 250px;">
                <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px; color: #667eea;">
                    üéì H·ªá th·ªëng Tr·∫Øc nghi·ªám LAN
                </div>
                <div style="font-size: 0.85em; color: #aaa;">
                    Ph·∫ßn m·ªÅm thi tr·∫Øc nghi·ªám tr√™n m·∫°ng n·ªôi b·ªô
                </div>
            </div>
            <div style="flex: 1; min-width: 250px; text-align: center;">
                <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">
                    üë®‚Äçüíª <span style="color: #ffd700;">Nguy·ªÖn Quang H√πng</span>
                </div>
                <div style="display: flex; justify-content: center; gap: 25px; flex-wrap: wrap;">
                    <a href="mailto:nqh2610@gmail.com" style="color: #4fc3f7; text-decoration: none; display: flex; align-items: center; gap: 5px; transition: color 0.3s;">
                        <span style="font-size: 1.2em;">‚úâÔ∏è</span> nqh2610@gmail.com
                    </a>
                    <a href="tel:0976385309" style="color: #81c784; text-decoration: none; display: flex; align-items: center; gap: 5px; transition: color 0.3s;">
                        <span style="font-size: 1.2em;">üì±</span> 0976.385.309
                    </a>
                </div>
            </div>
            <div style="flex: 1; min-width: 150px; text-align: right;">
                <div style="font-size: 0.85em; color: #888;">
                    ¬© 2025 All rights reserved
                </div>
                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                    Version 1.0
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
